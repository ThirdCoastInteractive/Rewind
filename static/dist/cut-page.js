(()=>{function m(s,t,e){return Math.max(t,Math.min(e,s))}function d(s){return typeof s=="number"&&isFinite(s)}function F(s,t,e,i){let r=Number(s);return Number.isFinite(r)?Math.max(t,Math.min(e,r)):i}function tt(s){if(typeof s!="string")return null;let t=s.trim().match(/^(\d+(?:\.\d+)?)\s*:\s*(\d+(?:\.\d+)?)$/);if(!t)return null;let e=F(t[1],.001,1e3,0),i=F(t[2],.001,1e3,0),r=e/i;return!Number.isFinite(r)||r<=0?null:r}function N(s){if(!d(s)||s<0)return"0:00";let t=Math.floor(s/3600),e=Math.floor(s%3600/60),i=Math.floor(s%60);return t>0?`${t}:${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${e}:${i.toString().padStart(2,"0")}`}function $(s){if(!d(s)||s<0)return"00:00:00.000";let t=Math.floor(s*1e3),e=t%1e3,i=Math.floor(t/1e3),r=i%60,o=Math.floor(i/60),n=o%60;return`${Math.floor(o/60).toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}.${e.toString().padStart(3,"0")}`}function st(s,t){if(!d(s)||s<0||!d(t)||t<=0)return"--:--:--:--";let e=Math.floor(s*t),i=Math.max(1,Math.round(t)),r=e%i,o=Math.floor(e/i),n=o%60,a=Math.floor(o/60),c=a%60;return`${Math.floor(a/60).toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}var ot={set_in_point:"F14",set_out_point:"F15",create_clip:"F16",play_pause:"F17",seek_back:"F18",seek_forward:"F19",prev_frame:"F20",next_frame:"F21",create_marker:"F22"};function nt(){let s=document.getElementById("rewind-keybindings");if(!s)return{};let t=s.dataset?.keybindings;if(!t)return{};try{return JSON.parse(t)||{}}catch(e){return console.warn("Failed to parse keybindings:",e),{}}}function at(s){let t={};return Object.entries(s||{}).forEach(([e,i])=>{i&&(t[i]=e)}),t}var wt=(()=>{let s=null;return()=>s||(s=document.createElement("div"),s.style.position="fixed",s.style.left="-9999px",s.style.top="-9999px",s.style.width="1px",s.style.height="1px",s.style.pointerEvents="none",document.body?.appendChild(s),s)})();function bt(s){let t=s.match(/rgba?\(([^)]+)\)/i);if(!t)return null;let e=t[1].split(",").map(i=>Number(i.trim()));return e.length<3||e.some(i=>!d(i))?null:{r:e[0],g:e[1],b:e[2]}}function q(s){if(!s||typeof s!="string")return null;let t=wt();if(!t)return null;t.style.color="",t.style.color=s;let e=getComputedStyle(t).color||"";return bt(e)}function O(s){let t=s/255;return t<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function kt(s){let t=O(s.r),e=O(s.g),i=O(s.b);return .2126*t+.7152*e+.0722*i}function rt(s,t,e){let i=Math.max(0,Math.min(1,e));return{r:s.r+(t.r-s.r)*i,g:s.g+(t.g-s.g)*i,b:s.b+(t.b-s.b)*i}}function St(s,t=1){let e=Math.round(s.r),i=Math.round(s.g),r=Math.round(s.b);return t>=1?`rgb(${e}, ${i}, ${r})`:`rgba(${e}, ${i}, ${r}, ${t.toFixed(3)})`}function et(s,t,e){let i=q(s);if(!i)return"rgba(255,255,255,0.35)";let r=q(t)||{r:10,g:10,b:10},o=Math.max(0,Math.min(1,e??.25)),n=rt(r,i,o),c=kt(n)<.35?{r:255,g:255,b:255}:{r:0,g:0,b:0},l=rt(i,c,.65);return St(l,.9)}function lt(s){let t=O(s.r),e=O(s.g),i=O(s.b),r=.4122214708*t+.5363325363*e+.0514459929*i,o=.2119034982*t+.6806995451*e+.1073969566*i,n=.0883024619*t+.2817188376*e+.6299787005*i,a=Math.cbrt(r),c=Math.cbrt(o),l=Math.cbrt(n),h=.2104542553*a+.793617785*c-.0040720468*l,u=1.9779984951*a-2.428592205*c+.4505937099*l,f=.0259040371*a+.7827717662*c-.808675766*l,v=Math.sqrt(u*u+f*f),g=Math.atan2(f,u)*(180/Math.PI);return g<0&&(g+=360),{L:h*100,C:v,H:g}}function R(s,t,e,i){let r=s.getBoundingClientRect(),o=m(t.clientX-r.left,0,r.width),n=r.width>0?o/r.width:0;return e+n*(i-e)}function ct(s){return s&&{id:(s.id||s.ID||"").toString(),startTs:s.StartTs??s.start_ts??0,endTs:s.EndTs??s.end_ts??0,color:(s.Color??s.color??"").toString(),title:(s.Title??s.title??"").toString(),_raw:s}}function D(s){document.documentElement.dataset.dragCursor=s}function dt(){delete document.documentElement.dataset.dragCursor}function ht(s){return s&&{id:(s.id||s.ID||"").toString(),timestamp:s.Timestamp??s.timestamp??s.time??0,color:(s.Color??s.color??"").toString(),title:(s.Title??s.title??"").toString(),duration:s.Duration??s.duration??null,_raw:s}}var B=class{constructor(t){this.video=t,this.ctx=null,this.source=null,this.activeNodes=[],this.onRebuild=null}ensureContext(){this.ctx||(this.ctx=new AudioContext,this.source=this.ctx.createMediaElementSource(this.video),this.source.connect(this.ctx.destination),this.ctx.state==="suspended"&&this.ctx.resume())}rebuild(t,e){if(t.length===0&&!e){this.ctx&&(this.source.disconnect(),this.activeNodes.forEach(r=>r.disconnect()),this.activeNodes=[],this.source.connect(this.ctx.destination),this.onRebuild&&this.onRebuild(this.source,this.source,this.ctx.destination));return}if(this.ensureContext(),this.source.disconnect(),this.activeNodes.forEach(r=>r.disconnect()),this.activeNodes=[],e||t.length===0){e||this.source.connect(this.ctx.destination);return}let i=this.source;for(let r of t){let o;switch(r.type){case"gain":o=this.ctx.createGain(),o.gain.value=r.gain??1;break;case"biquad":o=this.ctx.createBiquadFilter(),o.type=r.filter,o.frequency.value=r.frequency??1e3,r.Q!=null&&(o.Q.value=r.Q),r.gain!=null&&(o.gain.value=r.gain);break;case"compressor":o=this.ctx.createDynamicsCompressor(),o.threshold.value=r.threshold??-24,o.ratio.value=r.ratio??4,o.attack.value=r.attack??.003,o.release.value=r.release??.25;break;case"fade_in":{o=this.ctx.createGain();let n=this.ctx.currentTime;o.gain.setValueAtTime(0,n),o.gain.linearRampToValueAtTime(1,n+(r.duration||.5));break}case"fade_out":{o=this.ctx.createGain();break}default:continue}i.connect(o),this.activeNodes.push(o),i=o}i.connect(this.ctx.destination),this.onRebuild&&this.onRebuild(this.source,i,this.ctx.destination)}updateParam(t,e,i){let r=this.activeNodes[t];r&&r[e]instanceof AudioParam&&(r[e].value=i)}destroy(){this.ctx&&this.ctx.close().catch(()=>{}),this.ctx=null,this.source=null,this.activeNodes=[]}};var A=class{constructor(t,e){this.video=t,this.container=e,this.audioGraph=new B(t),this.overlayContainer=null,this.currentStack=[],this._savedPlaybackRate=null}apply(t){this.currentStack=t||[];let e=this.compile(this.currentStack),i=e.filter!=="none"||e.transform!=="none";this.video.style.filter=e.filter,this.video.style.transform=e.transform,this._setCaptionsHidden(i),e.playbackRate!==1?(this._savedPlaybackRate===null&&(this._savedPlaybackRate=this.video.playbackRate),this.video.playbackRate=e.playbackRate):this._savedPlaybackRate!==null&&(this.video.playbackRate=this._savedPlaybackRate,this._savedPlaybackRate=null),this.video.muted=e.muted,this.updateOverlays(e.overlays),this.audioGraph.rebuild(e.audioNodes,e.muted)}clear(){this.currentStack=[],this.video.style.filter="",this.video.style.transform="",this._setCaptionsHidden(!1),this._savedPlaybackRate!==null&&(this.video.playbackRate=this._savedPlaybackRate,this._savedPlaybackRate=null),this.video.muted=!1,this.clearOverlays(),this.audioGraph.rebuild([],!1)}updateParam(t,e,i){this.currentStack[t]&&(this.currentStack[t].params||(this.currentStack[t].params={}),this.currentStack[t].params[e]=i,this.apply(this.currentStack))}compile(t){let e=[],i=[],r=[],o=1,n=!1,a=[];for(let c of t){let l=c.params||{};switch(c.type){case"brightness":e.push(`brightness(${1+(l.value||0)})`);break;case"contrast":e.push(`contrast(${l.value??1})`);break;case"saturation":e.push(`saturate(${l.value??1})`);break;case"gamma":l.value&&l.value!==1&&e.push(`brightness(${Math.pow(.5,1/l.value)*2})`);break;case"grayscale":e.push("grayscale(1)");break;case"sepia":e.push("sepia(1)");break;case"color_temp":{let h=l.temperature??6500;if(h<6500){let f=(6500-h)/5500;e.push(`sepia(${f*.3}) saturate(${1+f*.3})`)}else if(h>6500){let f=(h-6500)/5500;e.push(`hue-rotate(${f*30}deg) saturate(${1-f*.15})`)}let u=l.tint??0;u!==0&&e.push(`hue-rotate(${u*20}deg)`);break}case"lift_gamma_gain":{let h=l.lift??0,u=l.gamma??1,f=l.gain??1;h!==0&&e.push(`brightness(${1+h})`),u!==1&&e.push(`brightness(${Math.pow(.5,1/u)*2})`),f!==1&&e.push(`contrast(${f})`);break}case"exposure":{let h=l.exposure??0;h!==0&&e.push(`brightness(${Math.pow(2,h)})`);break}case"lut":{let h={cinematic_warm:"sepia(0.2) contrast(1.1) saturate(0.9)",cinematic_cool:"hue-rotate(10deg) contrast(1.15) saturate(0.85)",film_noir:"grayscale(1) contrast(1.4) brightness(1.05)",bleach_bypass:"saturate(0.4) contrast(1.3) brightness(1.05)",orange_teal:"sepia(0.15) saturate(1.2) contrast(1.1)",vintage_fade:"sepia(0.3) contrast(0.9) brightness(1.05) saturate(0.7)",high_contrast:"grayscale(1) contrast(1.6)",pastel:"saturate(0.6) brightness(1.1)",golden_hour:"sepia(0.25) saturate(1.15) brightness(1.03)",moonlit:"hue-rotate(20deg) saturate(0.6) brightness(0.95)"};l.preset&&h[l.preset]&&e.push(h[l.preset]);break}case"sharpen":break;case"denoise":break;case"hflip":i.push("scaleX(-1)");break;case"vflip":i.push("scaleY(-1)");break;case"transpose":{let h=String(l.direction||"cw");h==="cw"?i.push("rotate(90deg)"):h==="ccw"?i.push("rotate(-90deg)"):h==="ccw_flip"?i.push("rotate(-90deg) scaleX(-1)"):h==="cw_flip"&&i.push("rotate(90deg) scaleX(-1)");break}case"speed":o=l.factor||1;break;case"mute":n=!0;break;case"vignette":a.push({type:"vignette",angle:l.angle??.5});break;case"text":a.push({type:"text",text:l.text||"",position:l.position||"bottom-right",size:l.size||24});break;case"curves":{let h={lighter:"brightness(1.1)",darker:"brightness(0.85)",increase_contrast:"contrast(1.3)",negative:"invert(1)",cross_process:"hue-rotate(20deg) saturate(1.3)",vintage:"sepia(0.3) contrast(1.1) brightness(1.05)"};h[l.preset]&&e.push(h[l.preset]);break}case"volume":r.push({type:"gain",gain:l.gain??1});break;case"bass":r.push({type:"biquad",filter:"lowshelf",frequency:200,gain:l.gain??0});break;case"treble":r.push({type:"biquad",filter:"highshelf",frequency:4e3,gain:l.gain??0});break;case"equalizer":r.push({type:"biquad",filter:"peaking",frequency:l.frequency??1e3,Q:(l.width??200)>0?(l.frequency??1e3)/(l.width??200):5,gain:l.gain??0});break;case"highpass":r.push({type:"biquad",filter:"highpass",frequency:l.frequency??200});break;case"lowpass":r.push({type:"biquad",filter:"lowpass",frequency:l.frequency??8e3});break;case"compressor":r.push({type:"compressor",threshold:l.threshold??-24,ratio:l.ratio??4,attack:(l.attack??20)/1e3,release:(l.release??250)/1e3});break;case"audio_fade_in":r.push({type:"fade_in",duration:l.duration??.5});break;case"audio_fade_out":r.push({type:"fade_out",duration:l.duration??.5});break;case"noise_gate":r.push({type:"gate",threshold:l.threshold??-40});break}}return{filter:e.join(" ")||"none",transform:i.join(" ")||"none",playbackRate:o,muted:n,overlays:a,audioNodes:r}}ensureOverlayContainer(){this.overlayContainer||(this.overlayContainer=this.video.parentElement.querySelector("[data-filter-preview-overlays]"),this.overlayContainer||(this.overlayContainer=document.querySelector("[data-filter-preview-overlays]")),this.overlayContainer&&(this.overlayContainer.style.display="",this._vignetteSlot=this.overlayContainer.querySelector("[data-overlay-vignette]"),this._textSlot=this.overlayContainer.querySelector("[data-overlay-text]")))}updateOverlays(t){if(!t.length){this.clearOverlays();return}if(this.ensureOverlayContainer(),!!this.overlayContainer){this._vignetteSlot&&(this._vignetteSlot.style.display="none",this._vignetteSlot.style.background=""),this._textSlot&&(this._textSlot.style.display="none",this._textSlot.textContent="",this._textSlot.style.fontSize="");for(let e of t)switch(e.type){case"vignette":{if(!this._vignetteSlot)break;let i=Math.min(1,Math.max(0,e.angle??.5));this._vignetteSlot.style.display="",this._vignetteSlot.style.background=`radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,${i}) 100%)`;break}case"text":{if(!this._textSlot)break;this._textSlot.textContent=e.text||"",this._textSlot.style.fontSize=(e.size||24)+"px",this._textSlot.style.display="",this._positionOverlay(this._textSlot,e.position||"bottom-center");break}}}}_positionOverlay(t,e){let i={"top-left":"top:0;left:0;bottom:auto;right:auto;transform:none;","top-center":"top:0;left:50%;bottom:auto;right:auto;transform:translateX(-50%);","top-right":"top:0;right:0;bottom:auto;left:auto;transform:none;",center:"top:50%;left:50%;bottom:auto;right:auto;transform:translate(-50%,-50%);","bottom-left":"bottom:0;left:0;top:auto;right:auto;transform:none;","bottom-center":"bottom:0;left:50%;top:auto;right:auto;transform:translateX(-50%);","bottom-right":"bottom:0;right:0;top:auto;left:auto;transform:none;"};t.style.cssText+=i[e]||i["bottom-center"]}clearOverlays(){this._vignetteSlot&&(this._vignetteSlot.style.display="none"),this._textSlot&&(this._textSlot.style.display="none")}destroy(){this.clear(),this.audioGraph.destroy(),this.overlayContainer&&(this.overlayContainer.style.display="none",this.overlayContainer=null)}_setCaptionsHidden(t){for(let e of this.video.textTracks)(e.kind==="subtitles"||e.kind==="captions")&&(e.mode=t?"hidden":"showing")}};var K=class{constructor(t){this.audioGraph=t,this.analyserPre=null,this.analyserPost=null,this.canvases={meter:null,spectrum:null,scope:null},this._raf=null,this._running=!1,this._peakHoldL=-1/0,this._peakHoldR=-1/0,this._peakHoldDecay=0,this._peakClipL=!1,this._peakClipR=!1,this._clipClearTimer=null,this._smoothRmsL=-60,this._smoothRmsR=-60,this._smoothPeakL=-60,this._smoothPeakR=-60}attach(t,e,i){this.canvases.meter=t||null,this.canvases.spectrum=e||null,this.canvases.scope=i||null}start(){this._running||(this._running=!0,this._tick())}stop(){this._running=!1,this._raf&&(cancelAnimationFrame(this._raf),this._raf=null)}ensureAnalysers(){let t=this.audioGraph;if(!t||!t.ctx)return!1;let e=t.ctx;return this.analyserPre||(this.analyserPre=e.createAnalyser(),this.analyserPre.fftSize=2048,this.analyserPre.smoothingTimeConstant=.8),this.analyserPost||(this.analyserPost=e.createAnalyser(),this.analyserPost.fftSize=2048,this.analyserPost.smoothingTimeConstant=.8),!0}tap(t,e,i){if(this.ensureAnalysers())try{try{this.analyserPre.disconnect()}catch{}try{this.analyserPost.disconnect()}catch{}t.connect(this.analyserPre);try{e.disconnect(i)}catch{}e.connect(this.analyserPost),this.analyserPost.connect(i)}catch{}}_tick(){this._running&&(this._raf=requestAnimationFrame(()=>this._tick()),this._drawMeter(),this._drawSpectrum(),this._drawScope())}_cssSize(t){let e=window.devicePixelRatio||1;return{w:t.width/e,h:t.height/e}}_drawMeter(){let t=this.canvases.meter;if(!t)return;let e=t.getContext("2d"),{w:i,h:r}=this._cssSize(t);e.fillStyle="#0a0a0a",e.fillRect(0,0,i,r);let o=this.analyserPost||this.analyserPre;if(!o){this._drawMeterOff(e,i,r);return}let n=new Float32Array(o.fftSize);o.getFloatTimeDomainData(n);let a=n.length>>1,c=0,l=0,h=0,u=0;for(let _=0;_<a;_++){let P=n[_];c+=P*P,Math.abs(P)>l&&(l=Math.abs(P))}for(let _=a;_<n.length;_++){let P=n[_];h+=P*P,Math.abs(P)>u&&(u=Math.abs(P))}let f=Math.sqrt(c/a)||1e-10,v=Math.sqrt(h/(n.length-a))||1e-10,g=20*Math.log10(f),E=20*Math.log10(v),p=20*Math.log10(l||1e-10),y=20*Math.log10(u||1e-10),k=.4,S=.05;this._smoothRmsL+=(g-this._smoothRmsL)*(g>this._smoothRmsL?k:S),this._smoothRmsR+=(E-this._smoothRmsR)*(E>this._smoothRmsR?k:S),this._smoothPeakL+=(p-this._smoothPeakL)*(p>this._smoothPeakL?k:S),this._smoothPeakR+=(y-this._smoothPeakR)*(y>this._smoothPeakR?k:S),this._smoothPeakL>this._peakHoldL&&(this._peakHoldL=this._smoothPeakL,this._peakHoldDecay=30),this._smoothPeakR>this._peakHoldR&&(this._peakHoldR=this._smoothPeakR,this._peakHoldDecay=30),this._peakHoldDecay>0?this._peakHoldDecay--:(this._peakHoldL-=.5,this._peakHoldR-=.5),p>-.5&&(this._peakClipL=!0),y>-.5&&(this._peakClipR=!0),clearTimeout(this._clipClearTimer),this._clipClearTimer=setTimeout(()=>{this._peakClipL=!1,this._peakClipR=!1},2e3);let w=Math.floor((i-16)/2),b=4,T=b+w+8,C=14,x=r-4,I=x-C,M=_=>C+(1-(Math.max(-60,Math.min(0,_))+60)/60)*I,W=_=>x-M(_);this._drawSingleMeter(e,b,C,w,I,x,M,W,this._smoothRmsL,this._smoothPeakL,this._peakHoldL,this._peakClipL),this._drawSingleMeter(e,T,C,w,I,x,M,W,this._smoothRmsR,this._smoothPeakR,this._peakHoldR,this._peakClipR),e.fillStyle="#666",e.font="9px monospace",e.textAlign="center",e.fillText("L",b+w/2,10),e.fillText("R",T+w/2,10),e.textAlign="right",e.fillStyle="#444";for(let _ of[0,-6,-12,-18,-24,-36,-48,-60]){let P=M(_);e.fillText(String(_),i-1,P+3),e.fillRect(b,P,w,1),e.fillRect(T,P,w,1)}}_drawSingleMeter(t,e,i,r,o,n,a,c,l,h,u,f){let v=t.createLinearGradient(0,n,0,i);v.addColorStop(0,"#22c55e"),v.addColorStop(.6,"#eab308"),v.addColorStop(.85,"#f97316"),v.addColorStop(1,"#ef4444"),t.fillStyle="#1a1a1a",t.fillRect(e,i,r,o),t.fillStyle=v;let g=c(l);t.fillRect(e,n-g,r,g);let E=a(h);t.fillStyle=h>-6?"#ef4444":"#fff",t.fillRect(e,E,r,2);let p=a(u);t.fillStyle="#fff8",t.fillRect(e,p,r,1),f&&(t.fillStyle="#ef4444",t.fillRect(e,i-2,r,3))}_drawMeterOff(t,e,i){t.fillStyle="#333",t.font="10px monospace",t.textAlign="center",t.fillText("NO SIGNAL",e/2,i/2+3)}_drawSpectrum(){let t=this.canvases.spectrum;if(!t)return;let e=t.getContext("2d"),{w:i,h:r}=this._cssSize(t);e.fillStyle="#0a0a0a",e.fillRect(0,0,i,r);let o=this.analyserPost||this.analyserPre;if(!o)return;let n=new Uint8Array(o.frequencyBinCount);o.getByteFrequencyData(n);let a=o.context.sampleRate,c=n.length,l=28,h=4,u=4,f=16,v=i-l-h,g=r-u-f,E=20,p=Math.min(2e4,a/2),y=Math.log10(E),k=Math.log10(p);e.strokeStyle="#222",e.lineWidth=1,e.font="8px monospace",e.fillStyle="#555",e.textAlign="center";for(let w of[50,100,200,500,1e3,2e3,5e3,1e4,2e4]){if(w>p)continue;let b=l+(Math.log10(w)-y)/(k-y)*v;e.beginPath(),e.moveTo(b,u),e.lineTo(b,u+g),e.stroke();let T=w>=1e3?w/1e3+"k":String(w);e.fillText(T,b,r-2)}e.textAlign="right";for(let w of[0,-12,-24,-36,-48]){let b=u+(1-(w+60)/60)*g;e.beginPath(),e.moveTo(l,b),e.lineTo(l+v,b),e.stroke(),e.fillText(String(w),l-2,b+3)}let S=e.createLinearGradient(0,u+g,0,u);S.addColorStop(0,"rgba(34, 197, 94, 0.6)"),S.addColorStop(.5,"rgba(234, 179, 8, 0.6)"),S.addColorStop(1,"rgba(239, 68, 68, 0.6)"),e.beginPath(),e.moveTo(l,u+g);for(let w=0;w<v;w++){let b=y+w/v*(k-y),T=Math.pow(10,b),C=Math.round(T/(a/2)*c),x=Math.max(0,Math.min(c-1,C)),I=n[x]/255,M=u+(1-I)*g;e.lineTo(l+w,M)}e.lineTo(l+v,u+g),e.closePath(),e.fillStyle=S,e.fill(),e.beginPath();for(let w=0;w<v;w++){let b=y+w/v*(k-y),T=Math.pow(10,b),C=Math.round(T/(a/2)*c),x=Math.max(0,Math.min(c-1,C)),I=n[x]/255,M=u+(1-I)*g;w===0?e.moveTo(l+w,M):e.lineTo(l+w,M)}e.strokeStyle="#22c55e",e.lineWidth=1.5,e.stroke()}_drawScope(){let t=this.canvases.scope;if(!t)return;let e=t.getContext("2d"),{w:i,h:r}=this._cssSize(t);e.fillStyle="#0a0a0a",e.fillRect(0,0,i,r);let o=this.analyserPost||this.analyserPre;if(!o)return;let n=new Float32Array(o.fftSize);o.getFloatTimeDomainData(n);let a=4,l=i-a-4,h=r/2,u=r/2-4;e.strokeStyle="#333",e.lineWidth=1,e.beginPath(),e.moveTo(a,h),e.lineTo(a+l,h),e.stroke(),e.strokeStyle="#222",e.beginPath(),e.moveTo(a,h-u*.5),e.lineTo(a+l,h-u*.5),e.moveTo(a,h+u*.5),e.lineTo(a+l,h+u*.5),e.stroke(),e.beginPath();let f=n.length/l;for(let g=0;g<l;g++){let E=Math.floor(g*f),p=h-n[E]*u;g===0?e.moveTo(a+g,p):e.lineTo(a+g,p)}let v=0;for(let g=0;g<n.length;g++)Math.abs(n[g])>v&&(v=Math.abs(n[g]));e.strokeStyle=v>.95?"#ef4444":v>.5?"#eab308":"#22c55e",e.lineWidth=1.5,e.stroke(),e.fillStyle="#444",e.font="8px monospace",e.textAlign="left",e.fillText("+1",a+1,10),e.fillText("-1",a+1,r-3),e.fillText("0",a+1,h-2)}destroy(){if(this.stop(),this.analyserPre)try{this.analyserPre.disconnect()}catch{}if(this.analyserPost)try{this.analyserPost.disconnect()}catch{}this.analyserPre=null,this.analyserPost=null,this.canvases={meter:null,spectrum:null,scope:null}}};var X=class{constructor(t){this.editor=t,this.manifest=null,this.peaks=null}async loadAssets(){let t=this.editor.videoID;if(t)try{let e=await fetch(`/api/videos/${encodeURIComponent(t)}/waveform/waveform.json`,{headers:{Accept:"application/json"}});if(!e.ok)return;let i=await e.json();if(!i||typeof i!="object"||!i.peaks_path)return;let r=await fetch(`/api/videos/${encodeURIComponent(t)}/waveform/peaks.i16`,{headers:{Accept:"application/octet-stream"}});if(!r.ok)return;let o=await r.arrayBuffer(),n=new Int16Array(o);if(!n||n.length===0)return;this.manifest=i,this.peaks=n}catch{}}findNearestZeroCrossingTime(t,e){let i=this.peaks,r=this.manifest;if(!i||!r)return null;let o=Number(r.bucket_ms),n=isFinite(o)&&o>0?o/1e3:0;if(!n)return null;let a=Math.round(t/n);if(!isFinite(a))return null;let c=Math.max(1,Math.floor((e||.25)/n)),l=i.length-2,h=v=>Math.max(0,Math.min(l,v)),u=null,f=1/0;for(let v=0;v<=c;v++){let g=h(a-v),E=h(a+v);for(let p of[g,E]){let y=i[p],k=i[p+1];if(!(!isFinite(y)||!isFinite(k))&&!(y===0||k===0)&&(y>0&&k<0||y<0&&k>0)){let S=Math.abs(p-a);S<f&&(f=S,u=p)}}if(u!=null)break}return u==null?null:u*n}drawToCanvas(t,e,i){let r=this.peaks,o=this.manifest;if(!r||!o)return;let n=Number(o.bucket_ms),a=isFinite(n)&&n>0?n/1e3:0;if(!a)return;let c=t?.getContext?.("2d");if(!c)return;let l=t.width,h=t.height;if(!l||!h)return;c.clearRect(0,0,l,h),c.strokeStyle="rgba(255,255,255,0.85)",c.lineWidth=1;let u=h/2,f=i-e;c.beginPath();for(let v=0;v<l;v++){let g=e+v/l*f,E=e+(v+1)/l*f,p=Math.floor(g/a),y=Math.floor(E/a);if(isFinite(p)||(p=0),isFinite(y)||(y=p),p<0&&(p=0),y<p&&(y=p),p>=r.length)break;y>=r.length&&(y=r.length-1);let k=0;for(let b=p;b<=y;b++){let T=Math.abs(r[b]||0);T>k&&(k=T)}let w=m(k/32767,0,1)*(h*.45);c.moveTo(v+.5,u-w),c.lineTo(v+.5,u+w)}c.stroke()}};var ut={seekRelative(s){if(!this.video||!d(this.duration))return;let t=Math.max(0,Math.min(this.duration,this.video.currentTime+s));this.video.currentTime=t,this.workHeadTime=t,this.renderPlayheads(),this.updateTransportTime()},transportGoToStart(){this.video&&(this.video.currentTime=0,this.workHeadTime=0,this.renderPlayheads(),this.updateTransportTime())},transportGoToEnd(){!this.video||!d(this.duration)||(this.video.currentTime=this.duration,this.workHeadTime=this.duration,this.renderPlayheads(),this.updateTransportTime())},transportPrevFrame(){if(!this.video)return;let t=1/(d(this.videoFps)&&this.videoFps>0?this.videoFps:30),e=Math.max(0,this.video.currentTime-t);this.video.currentTime=e,this.workHeadTime=e,this.renderPlayheads(),this.updateTransportTime()},transportNextFrame(){if(!this.video)return;let t=1/(d(this.videoFps)&&this.videoFps>0?this.videoFps:30),e=d(this.duration)?this.duration:this.video.duration||1/0,i=Math.min(e,this.video.currentTime+t);this.video.currentTime=i,this.workHeadTime=i,this.renderPlayheads(),this.updateTransportTime()},transportStop(){this.video&&(this.video.pause(),this.video.currentTime=0,this.workHeadTime=0,this.renderPlayheads(),this.updateTransportTime(),this.updateTransportPlayButton())},transportPlay(){this.video&&(this.video.play().catch(()=>{}),this.updateTransportPlayButton())},transportTogglePlay(){this.video&&(this.video.paused?this.video.play().catch(()=>{}):this.video.pause(),this.updateTransportPlayButton())},transportToggleLoop(){this.transportLoopEnabled=!this.transportLoopEnabled,this.updateTransportLoopButton()},updateTransportPlayButton(){if(!this.btnTransportPlay)return;let s=this.btnTransportPlay.querySelector("i");s&&(s.className=this.video?.paused?"fa-sharp fa-solid fa-play":"fa-sharp fa-solid fa-pause")},updateTransportLoopButton(){this.btnTransportLoop&&(this.transportLoopEnabled?this.btnTransportLoop.classList.add("text-primary","border-primary"):this.btnTransportLoop.classList.remove("text-primary","border-primary"))},updateTransportTime(){if(!this.transportTimeEl)return;let s=this.video?.currentTime||0,t=d(this.duration)?this.duration:this.video?.duration||0;this.transportTimeEl.textContent=`${$(s)} / ${$(t)}`},toggleFilmstrip(){this.showFilmstrip=!this.showFilmstrip,localStorage.setItem("cut-editor-show-filmstrip",this.showFilmstrip?"true":"false"),this.render()},renderLoopButton(){this.btnLoop&&(this.btnLoop.textContent=this.loopEnabled?"LOOP: ON":"LOOP: OFF")},renderPlaySelectionButton(){if(this.btnPlaySelection){if(!this.video){this.btnPlaySelection.textContent="PLAY";return}this.btnPlaySelection.textContent=this.video.paused?"PLAY":"PAUSE"}},toggleLoop(){this.loopEnabled=!this.loopEnabled,this.renderLoopButton(),this.loopEnabled&&(this.stopAtOut=!1)},togglePlaySelection(){if(this.video){if(!this.video.paused){this.stopAtOut=!1,this.video.pause(),this.renderPlaySelectionButton();return}this.playSelection(),this.renderPlaySelectionButton()}},async playSelection(){if(!this.video)return;let s=this.getSelectionRange();if(s){this.video.currentTime=s.start;try{await this.video.play()}catch{}this.stopAtOut=!this.loopEnabled,this.renderPlaySelectionButton()}},handleSelectionPlaybackTick(){if(!this.video||!d(this.video.currentTime)||this.video.seeking)return;let s=this.getSelectionRange();if(!s)return;let t=.02,e=this.video.currentTime;if(this.loopEnabled){e>=s.end-t&&(this.video.currentTime=Math.min(s.start+t,s.end),this.video.paused&&this.video.play().catch(()=>{}));return}this.stopAtOut&&e>=s.end-t&&(this.stopAtOut=!1,this.video.pause(),this.video.currentTime=s.end,this.renderPlaySelectionButton())}};var Y=class{constructor(t){this.editor=t,this.crop={x:.5,y:.5,width:1,height:1,aspect:""},this.draggingCrop=!1,this.cropDragMode=null,this.cropDragStart=null,this.selectedCropId=null,this.cropLayerEl=null,this.cropSurfaceEl=null,this.cropRectEl=null,this.cropHandleEl=null}bindDOM(t,e,i,r){this.cropLayerEl=t,this.cropSurfaceEl=e,this.cropRectEl=i,this.cropHandleEl=r}getCropSurfaceAspectRatio(){let t=this.cropSurfaceEl,e=t?.clientWidth||0,i=t?.clientHeight||0;return!e||!i?16/9:e/i}enforceAspectOnSize(t,e,i,r){let a=t*r/i,c=e*i/r,l=t,h=a;if(Number.isFinite(a)&&Number.isFinite(c)){let g=Math.abs(a-e);Math.abs(c-t)<g&&(l=c,h=e)}if(!Number.isFinite(l)||!Number.isFinite(h)||l<=0||h<=0)return{width:t,height:e};let u=Math.min(1,1/l,1/h);l*=u,h*=u;let f=Math.max(1,.05/l,.05/h);l*=f,h*=f;let v=Math.min(1,1/l,1/h);return l*=v,h*=v,{width:l,height:h}}clampCropToBounds(t){let e=this.getCropSurfaceAspectRatio(),i=F(t.width,.05,1,1),r=F(t.height,.05,1,1),o=tt(t.aspect);if(o){let c=this.enforceAspectOnSize(i,r,o,e);i=c.width,r=c.height}let n=F(t.x,i/2,1-i/2,.5),a=F(t.y,r/2,1-r/2,.5);return{x:n,y:a,width:i,height:r,aspect:typeof t.aspect=="string"?t.aspect:""}}setCropState(t){let e={x:typeof t.x<"u"?t.x:this.crop.x,y:typeof t.y<"u"?t.y:this.crop.y,width:typeof t.width<"u"?t.width:this.crop.width,height:typeof t.height<"u"?t.height:this.crop.height,aspect:typeof t.aspect<"u"?t.aspect:this.crop.aspect};this.crop=this.clampCropToBounds(e)}loadCrop(t,e,i,r,o,n){this.setSelectedCropId(t);let a=typeof n=="string"?n.trim():"";if(!a&&d(r)&&d(o)&&o>0){let c=r/o;d(c)&&c>0&&(a=`${c.toFixed(4)}:1`)}this.setCropState({x:e,y:i,width:r,height:o,aspect:a}),this.renderOverlay()}setSelectedCropId(t){this.selectedCropId=t||null;let e=document.querySelector("[data-cut-selected-crop-id]");e&&(e.value=this.selectedCropId||"",e.dispatchEvent(new Event("input",{bubbles:!0})))}persistSelectedCrop(){if(!this.selectedCropId)return;let t=document.querySelector("[data-cut-crop-x]"),e=document.querySelector("[data-cut-crop-y]"),i=document.querySelector("[data-cut-crop-width]"),r=document.querySelector("[data-cut-crop-height]"),o=document.querySelector("[data-cut-crop-save-token]");!t||!e||!i||!r||!o||(t.value=this.crop.x,e.value=this.crop.y,i.value=this.crop.width,r.value=this.crop.height,t.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("input",{bubbles:!0})),o.value=Date.now(),o.dispatchEvent(new Event("input",{bubbles:!0})))}updateSurfaceLayout(){let t=this.editor.video;if(!t||!this.cropSurfaceEl||!t.parentElement)return;let i=t.clientWidth,r=t.clientHeight,o=t.videoWidth,n=t.videoHeight;if(!i||!r||!o||!n)return;let a=Math.min(i/o,r/n),c=o*a,l=n*a,h=(i-c)/2,u=(r-l)/2;this.cropSurfaceEl.style.left=`${h}px`,this.cropSurfaceEl.style.top=`${u}px`,this.cropSurfaceEl.style.width=`${c}px`,this.cropSurfaceEl.style.height=`${l}px`}renderOverlay(){if(!this.cropRectEl||!this.cropLayerEl||!this.cropSurfaceEl)return;let t=this.crop.width>=.99&&this.crop.height>=.99,e=!!this.selectedCropId&&!t;if(this.cropLayerEl.classList.toggle("hidden",!e),!e)return;let i=this.cropSurfaceEl.clientWidth,r=this.cropSurfaceEl.clientHeight;if(!i||!r)return;let o=(this.crop.x-this.crop.width/2)*i,n=(this.crop.y-this.crop.height/2)*r,a=this.crop.width*i,c=this.crop.height*r;this.cropRectEl.style.left=`${o}px`,this.cropRectEl.style.top=`${n}px`,this.cropRectEl.style.width=`${a}px`,this.cropRectEl.style.height=`${c}px`}beginDrag(t,e){if(!this.editor.selectedClipId||!this.cropSurfaceEl||!e)return;e.preventDefault(),e.stopPropagation();let i=this.cropSurfaceEl.getBoundingClientRect(),r=m(e.clientX-i.left,0,i.width),o=m(e.clientY-i.top,0,i.height),n=i.width>0?r/i.width:.5,a=i.height>0?o/i.height:.5;this.draggingCrop=!0,this.cropDragMode=t;let c=this.crop.x-this.crop.width/2,l=this.crop.y-this.crop.height/2;this.cropDragStart={pointerId:e.pointerId,startNx:n,startNy:a,orig:{...this.crop},anchorTL:{x:c,y:l}};let h=f=>this.handlePointerMove(f),u=f=>{this.endDrag(f),window.removeEventListener("pointermove",h),window.removeEventListener("pointerup",u),window.removeEventListener("pointercancel",u)};window.addEventListener("pointermove",h),window.addEventListener("pointerup",u),window.addEventListener("pointercancel",u)}getCropGuides(){let t=.61803398875,e=new Set([0,.5,1,1/3,2/3,1-t,t,1/9,2/9,4/9,5/9,7/9,8/9]);return Array.from(e).sort((i,r)=>i-r)}snap1D(t,e,i){let r=t,o=i;for(let n of e){let a=Math.abs(n-t);a<=o&&(o=a,r=n)}return r}snapCenterOrEdges(t,e,i,r){let o=t-e/2,n=t+e/2,a=t,c=r;for(let l of i)for(let h of[o,t,n]){let u=Math.abs(h-l);u<=c&&(c=u,a=t+(l-h))}return a}handlePointerMove(t){if(!this.draggingCrop||!this.cropDragStart||!this.cropSurfaceEl||t.pointerId!==this.cropDragStart.pointerId)return;t.preventDefault();let e=this.cropSurfaceEl.getBoundingClientRect(),i=m(t.clientX-e.left,0,e.width),r=m(t.clientY-e.top,0,e.height),o=e.width>0?i/e.width:.5,n=e.height>0?r/e.height:.5,a=this.getCropGuides(),c=8,l=e.width>0?c/e.width:0,h=e.height>0?c/e.height:0;if(this.cropDragMode==="move"){let u=o-this.cropDragStart.startNx,f=n-this.cropDragStart.startNy,v=this.cropDragStart.orig.x+u,g=this.cropDragStart.orig.y+f;v=this.snapCenterOrEdges(v,this.cropDragStart.orig.width,a,l),g=this.snapCenterOrEdges(g,this.cropDragStart.orig.height,a,h),this.setCropState({x:v,y:g}),this.renderOverlay();return}if(this.cropDragMode==="resize"){let u=this.getCropSurfaceAspectRatio(),f=tt(this.crop.aspect),v=this.cropDragStart.anchorTL,g=o,E=n;g=this.snap1D(g,a,l),E=this.snap1D(E,a,h);let p=F(g-v.x,.05,1,this.crop.width),y=F(E-v.y,.05,1,this.crop.height);if(f){let C=this.enforceAspectOnSize(p,y,f,u);p=C.width,y=C.height}let k=1-v.x,S=1-v.y,w=Math.min(1,k/p,S/y);p*=w,y*=w;let b=v.x+p/2,T=v.y+y/2;this.setCropState({x:b,y:T,width:p,height:y}),this.renderOverlay()}}endDrag(t){this.draggingCrop&&(t&&(t.preventDefault?.(),t.stopPropagation?.()),this.draggingCrop=!1,this.cropDragMode=null,this.cropDragStart=null,this.persistSelectedCrop())}};var G=class extends EventTarget{constructor(t){super(),this._videoID=t,this._clips=[],this._selectedClipId=null,this._reloadTimer=null,this._lastSignals={selectedClipId:"",clipDirty:!1,clipStartTs:0,clipEndTs:0}}get clips(){return this._clips}get selectedClipId(){return this._selectedClipId}getClipById(t){return this._clips.find(e=>e.id===t)}async reload(){let t=this._clips,e=new Set(t.map(r=>r.id));try{let r=await fetch(`/api/videos/${encodeURIComponent(this._videoID)}/clips`,{headers:{Accept:"application/json"}});if(!r.ok)return;this._clips=(await r.json()).map(ct)}catch{return}let i=new Set(this._clips.map(r=>r.id));this.dispatchEvent(new CustomEvent("clips:loaded",{detail:{clips:this._clips}}));for(let r of this._clips)e.has(r.id)||this.dispatchEvent(new CustomEvent("clip:created",{detail:{clip:r}}));for(let r of t)i.has(r.id)||this.dispatchEvent(new CustomEvent("clip:deleted",{detail:{clipId:r.id}}));for(let r of this._clips)if(e.has(r.id)){let o=t.find(n=>n.id===r.id);o&&Et(o,r)&&this.dispatchEvent(new CustomEvent("clip:updated",{detail:{clip:r}}))}}scheduleReload(){clearTimeout(this._reloadTimer),this._reloadTimer=setTimeout(()=>this.reload(),50)}handleSignalPatch(){let t=window.__dsAPI;if(!t)return;let e=(t.getPath("_selectedClipId")||"").toString(),i=!!t.getPath("_clipDirty"),r=parseFloat(t.getPath("_clipStartTs"))||0,o=parseFloat(t.getPath("_clipEndTs"))||0,n=this._lastSignals;e!==n.selectedClipId&&(n.selectedClipId=e,this._selectedClipId=e||null,e?this._resolveSelection(e):this.dispatchEvent(new CustomEvent("clip:deselected",{detail:{}}))),i!==n.clipDirty&&(n.clipDirty=i,this.dispatchEvent(new CustomEvent("clip:dirty-changed",{detail:{dirty:i,clipId:this._selectedClipId}}))),(r!==n.clipStartTs||o!==n.clipEndTs)&&(n.clipStartTs=r,n.clipEndTs=o,this.dispatchEvent(new CustomEvent("clip:timing-changed",{detail:{startTs:r,endTs:o,clipId:this._selectedClipId}})))}_resolveSelection(t,e=10){let i=this.getClipById(t);if(i){this.dispatchEvent(new CustomEvent("clip:selected",{detail:{clip:i,seekTime:i.startTs}}));return}e>0&&setTimeout(()=>this._resolveSelection(t,e-1),100)}};function Et(s,t){return s.startTs!==t.startTs||s.endTs!==t.endTs||s.color!==t.color||s.title!==t.title}var pt="rewind.colorSwatches",Tt=24,U=class{constructor(){this._initialized=!1,this._panel=null,this._nameInput=null,this._saveBtn=null}init(){if(this._initialized&&this._panel)return;let t=document.querySelector("[data-color-swatch-list]"),e=document.querySelector("[data-color-swatch-name]"),i=document.querySelector("[data-color-swatch-save]");!t||!e||!i||(this._initialized=!0,this._panel=t,this._nameInput=e,this._saveBtn=i,i.addEventListener("click",()=>this._handleSave()),this.render())}load(){try{let t=localStorage.getItem(pt),e=t?JSON.parse(t):[];return Array.isArray(e)?e.filter(i=>i&&typeof i=="object").map(i=>({name:typeof i.name=="string"?i.name:"",color:typeof i.color=="string"?i.color:""})).filter(i=>i.color&&i.color.length<128):[]}catch{return[]}}save(t){try{localStorage.setItem(pt,JSON.stringify(t))}catch{}}applyColor(t){let e=document.querySelector('[data-bind="clipColor"]'),i=document.querySelector('[data-bind="clipColorL"]'),r=document.querySelector('[data-bind="clipColorC"]'),o=document.querySelector('[data-bind="clipColorH"]');if(!e||!i||!r||!o)return;e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0}));let n=q(t);if(n){let a=lt(n);i.value=a.L.toFixed(1),r.value=a.C.toFixed(3),o.value=a.H.toFixed(1),i.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("input",{bubbles:!0}))}e.dispatchEvent(new Event("change",{bubbles:!0}))}render(){if(!this._panel)return;let t=this.load();this._panel.innerHTML="",t.forEach((e,i)=>{let r=document.createElement("div");r.className="flex items-center gap-2 border-2 border-white/10 px-2 py-1";let o=document.createElement("button");o.type="button",o.className="w-6 h-6 border-2 border-white/20",o.style.background=e.color||"",o.addEventListener("click",()=>this.applyColor(e.color||""));let n=document.createElement("div");n.className="flex-1 text-[11px] text-white/70 font-mono truncate",n.textContent=e.name&&e.name.trim()||e.color||"Swatch";let a=document.createElement("button");a.type="button",a.className="text-[10px] text-white/40 hover:text-white/80",a.textContent="\u2715",a.addEventListener("click",()=>{let c=t.filter((l,h)=>h!==i);this.save(c),this.render()}),r.appendChild(o),r.appendChild(n),r.appendChild(a),this._panel.appendChild(r)})}_handleSave(){let e=(document.querySelector('[data-bind="clipColor"]')?.value||"").trim();if(!e)return;let i=(this._nameInput?.value||"").trim(),r=this.load();r.unshift({name:i,color:e}),this.save(r.slice(0,Tt)),this._nameInput&&(this._nameInput.value=""),this.render()}};var j=class s{constructor(t){this.editor=t,this.manifest=null,this.vttByLevel=new Map,this.loadingVttByLevel=new Map,this.overviewTooltip=null,this.workTooltip=null,this._raf=null,this._showTimer=null,this._pendingKind=null,this._pendingEvt=null,this._renderSeq=0}async loadManifest(){let t=this.editor.videoID;if(t)try{let e=await fetch(`/api/videos/${encodeURIComponent(t)}/seek/seek.json`,{headers:{Accept:"application/json"}});if(!e.ok)return;let i=await e.json();if(!i||!Array.isArray(i.levels)||i.levels.length===0)return;this.manifest=i}catch{}}async ensureVttLoaded(t){if(!t||typeof t!="string")return null;if(this.vttByLevel.has(t))return this.vttByLevel.get(t);if(this.loadingVttByLevel.has(t))return this.loadingVttByLevel.get(t);let e=this.editor.videoID,i=(async()=>{try{let r=await fetch(`/api/videos/${encodeURIComponent(e)}/seek/levels/${encodeURIComponent(t)}/seek.vtt`,{headers:{Accept:"text/vtt"}});if(!r.ok)return null;let o=await r.text(),n=s.parseVTT(o);return n&&this.vttByLevel.set(t,n),n}catch{return null}finally{this.loadingVttByLevel.delete(t)}})();return this.loadingVttByLevel.set(t,i),i}static parseVTT(t){if(typeof t!="string")return null;let e=t.replace(/\r/g,"").split(`
`),i=[],r=0,o=n=>{let a=n.match(/^(\d+):(\d\d):(\d\d)\.(\d\d\d)$/);if(!a)return null;let c=Number(a[1]),l=Number(a[2]),h=Number(a[3]),u=Number(a[4]);return[c,l,h,u].every(f=>d(f))?c*3600+l*60+h+u/1e3:null};for(;r<e.length;){let n=e[r].trim();if(r++,!n||n.startsWith("WEBVTT")||n.startsWith("NOTE")||!n.includes("-->"))continue;let a=n.split("-->").map(f=>f.trim()),c=o(a[0]),l=o(a[1]);if(c==null||l==null)continue;for(;r<e.length&&!e[r].trim();)r++;if(r>=e.length)break;let h=e[r].trim();r++;let u=h.match(/^(seek-\d{3}\.jpg)#xywh=(\d+),(\d+),(\d+),(\d+)$/);u&&i.push({start:c,end:l,sheet:u[1],x:Number(u[2]),y:Number(u[3]),w:Number(u[4]),h:Number(u[5])})}return i.length>0?i:null}chooseLevelForRange(t,e,i){let r=this.manifest?.levels;if(!Array.isArray(r)||r.length===0)return null;let o=d(i)&&i>0?i:1,a=Math.max(1e-6,(e-t)/o)*8,c=null,l=1/0;for(let u of r){let f=Number(u?.interval_seconds);if(!isFinite(f)||f<=0)continue;let v=Math.abs(f-a);v<l&&(l=v,c=u)}let h=r.find(u=>(u?.name||"")==="medium");return c||h||r[0]}async renderRow(t,e,i,r,o){if(!e||!this.manifest)return;let n=d(o)&&o>0?o:1,a=this.chooseLevelForRange(i,r,n),c=(a?.name||"").toString();if(!c)return;let l=++this._renderSeq,h=await this.ensureVttLoaded(c);if(l!==this._renderSeq||!h||h.length===0)return;let u=Number(a?.interval_seconds);if(!isFinite(u)||u<=0)return;let f=t==="work"?56:40,v=Number(a?.cols)*Number(a?.thumb_width),g=Number(a?.rows)*Number(a?.thumb_height),E=Number(a?.thumb_width),p=Number(a?.thumb_height);e.innerHTML="",e.style.height=`${f}px`;let y=r-i;if(!d(y)||y<=0)return;let k=f/p,S=v*k,w=g*k,b=E*k,T=Math.max(b*.5,20),C=Math.ceil(n/T),x=Math.floor(i/u),M=Math.ceil(r/u)-x+1,W=M>C?M/C:1,_=W*u/y*n,P=this.editor.videoID,it=0;for(let J=0;J<C&&it<200;J++){let H=x+Math.floor(J*W);if(H<0||H>=h.length)continue;let z=h[H];if(!z)continue;let Q=(H*u-i)/y*n;if(Q+_<0||Q>n)continue;let L=document.createElement("div");L.className="absolute top-0 bottom-0 overflow-hidden",L.style.left=`${Q}px`,L.style.width=`${_}px`,L.style.height=`${f}px`;let yt=(_-b)/2;L.style.backgroundImage=`url(/api/videos/${encodeURIComponent(P)}/seek/levels/${encodeURIComponent(c)}/${encodeURIComponent(z.sheet)})`,L.style.backgroundRepeat="no-repeat",L.style.backgroundPosition=`${yt-z.x*k}px ${-z.y*k}px`,isFinite(S)&&isFinite(w)&&S>0&&w>0&&(L.style.backgroundSize=`${S}px ${w}px`),L.style.zIndex="1",L.style.opacity="0.9",L.style.pointerEvents="none",e.appendChild(L),it++}}ensureTooltip(t){if(!(t==="work"?this.editor.workEl:this.editor.overviewEl))return null;if(t==="work"&&this.workTooltip)return this.workTooltip;if(t!=="work"&&this.overviewTooltip)return this.overviewTooltip;let i=document.createElement("div");i.className="fixed z-50 pointer-events-none hidden",i.style.transform="translate(-50%, -100%)",i.style.marginTop="-8px";let r=document.createElement("div");r.className="border-2 border-white/20 bg-black",r.style.backgroundRepeat="no-repeat";let o=document.createElement("div");o.className="mt-1 text-[10px] text-white/80 font-mono text-center";let n=document.createElement("div");n.className="text-[10px] text-white/50 font-mono text-center";let a=document.createElement("div");a.className="px-2 py-1 bg-black/90 border border-white/20",a.appendChild(r),a.appendChild(o),a.appendChild(n),i.appendChild(a),document.body.appendChild(i);let c={tip:i,thumb:r,label:o,frame:n};return t==="work"?this.workTooltip=c:this.overviewTooltip=c,c}hideTooltip(t){this._showTimer&&(clearTimeout(this._showTimer),this._showTimer=null),this._pendingKind=null,this._pendingEvt=null;let e=t==="work"?this.workTooltip:this.overviewTooltip;!e||!e.tip||e.tip.classList.add("hidden")}queueTooltipUpdate(t,e){if(!this.manifest)return;let i=this.editor;if(!d(i.duration)||i.duration<=0)return;if(i.drag&&i.drag.type!=="none"&&i.drag.type!=="work-pending"){this.hideTooltip(t);return}if(e&&e.shiftKey){this.hideTooltip(t);return}this._pendingKind=t,this._pendingEvt=e;let r=t==="work"?this.workTooltip:this.overviewTooltip;if(r&&r.tip&&!r.tip.classList.contains("hidden")){if(this._raf)return;this._raf=requestAnimationFrame(()=>{this._raf=null,this.updateTooltip(t,e)});return}this._showTimer||(this._showTimer=setTimeout(()=>{this._showTimer=null,this._pendingKind===t&&this._pendingEvt&&this.updateTooltip(t,this._pendingEvt)},300))}async updateTooltip(t,e){let i=this.editor,r=t==="work"?i.workEl:i.overviewEl;if(!r||!e||!this.manifest)return;let o=this.ensureTooltip(t);if(!o)return;let n=r.getBoundingClientRect(),a=m(e.clientX-n.left,0,n.width);if(!d(a)){this.hideTooltip(t);return}let c=t==="work"?i.workStart:i.overviewStart,l=t==="work"?i.workEnd:i.overviewEnd;if(!d(c)||!d(l)||l<=c){this.hideTooltip(t);return}let h=this.chooseLevelForRange(c,l,n.width),u=(h?.name||"").toString();if(!u){this.hideTooltip(t);return}let f=await this.ensureVttLoaded(u);if(!f||f.length===0){this.hideTooltip(t);return}let v=n.width>0?a/n.width:0,g=c+v*(l-c),E=i.snapTime(g,e),p=Number(h?.interval_seconds),y=isFinite(p)&&p>0?Math.floor(E/p):0;(!isFinite(y)||y<0)&&(y=0),y>=f.length&&(y=f.length-1);let k=f[y];if(!k){this.hideTooltip(t);return}let S=i.videoID,w=`/api/videos/${encodeURIComponent(S)}/seek/levels/${encodeURIComponent(u)}/${encodeURIComponent(k.sheet)}`,b=Number(h?.cols)*Number(h?.thumb_width),T=Number(h?.rows)*Number(h?.thumb_height);o.thumb.style.width=`${k.w}px`,o.thumb.style.height=`${k.h}px`,o.thumb.style.backgroundImage=`url(${w})`,isFinite(b)&&isFinite(T)&&b>0&&T>0?o.thumb.style.backgroundSize=`${b}px ${T}px`:o.thumb.style.backgroundSize="",o.thumb.style.backgroundPosition=`-${k.x}px -${k.y}px`;let C=d(i.videoFps)&&i.videoFps>0?i.videoFps:0;o.label.textContent=$(E),o.frame.textContent=C>0?`${st(E,C)} \u2022 frame ${Math.floor(E*C)} @ ${C.toFixed(3)}fps`:"frame -- @ -- fps",o.tip.classList.remove("hidden");let x=o.tip.offsetWidth||0,I=n.left+a;x>0&&(I=Math.max(x/2,Math.min(window.innerWidth-x/2,I))),o.tip.style.left=`${I}px`;let M=m(e.clientY-n.top,0,n.height);o.tip.style.top=`${n.top+M}px`}};var V=class{constructor(t){this.editor=t}handleKeyDown(t){let e=this.editor;if(t.target?.isContentEditable||t.target?.tagName==="INPUT"||t.target?.tagName==="TEXTAREA"||t.target?.tagName==="SELECT")return;let i=t.key,r=i.toLowerCase(),o=t.ctrlKey||t.metaKey||t.altKey;if(i==="MediaPlayPause"){t.preventDefault(),e.transportTogglePlay();return}if(i==="MediaTrackPrevious"){t.preventDefault(),e.seekRelative(-10);return}if(i==="MediaTrackNext"){t.preventDefault(),e.seekRelative(10);return}if(!o){let a=e.keyMap[i];if(a){t.preventDefault(),this.executeKeybindingAction(a);return}}if((r===" "||r==="k")&&!o){t.preventDefault(),e.transportTogglePlay();return}if(r==="arrowleft"&&!t.shiftKey&&!o){t.preventDefault(),e.seekRelative(-5);return}if(r==="arrowright"&&!t.shiftKey&&!o){t.preventDefault(),e.seekRelative(5);return}if(r===","&&e.video?.paused&&!o){t.preventDefault(),e.transportPrevFrame();return}if(r==="."&&e.video?.paused&&!o){t.preventDefault(),e.transportNextFrame();return}if(r==="i"&&!t.shiftKey&&!o){t.preventDefault(),e.btnSetIn?.click();return}if(r==="o"&&!t.shiftKey&&!o){t.preventDefault(),e.btnSetOut?.click();return}if(r==="home"&&!o){t.preventDefault(),e.transportGoToStart();return}if(r==="end"&&!o){t.preventDefault(),e.transportGoToEnd();return}if(r==="e"&&!t.shiftKey&&!o&&e.selectedClipId){t.preventDefault(),e.editMode?e.exitEditMode():e.enterEditMode();return}if(r==="s"&&!t.shiftKey&&!o&&e.editMode&&e.selectedClipId){t.preventDefault(),e.splitClipAtPlayhead();return}if(r==="escape"&&!o){t.preventDefault(),e.editMode?e.exitEditMode():e.selectedClipId&&e.clearSelectedClip();return}let n=e.videoFps>0?1/e.videoFps:1/30;if(e.editMode&&e.selectedClipId){if(r===","&&t.shiftKey&&!t.altKey&&!t.ctrlKey&&!t.metaKey){t.preventDefault(),e.nudgeInPoint(-n);return}if(r==="."&&t.shiftKey&&!t.altKey&&!t.ctrlKey&&!t.metaKey){t.preventDefault(),e.nudgeInPoint(n);return}if(r===","&&t.altKey&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey){t.preventDefault(),e.nudgeOutPoint(-n);return}if(r==="."&&t.altKey&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey){t.preventDefault(),e.nudgeOutPoint(n);return}if(r===","&&t.shiftKey&&t.altKey&&!t.ctrlKey&&!t.metaKey){t.preventDefault(),e.nudgeSelection(-n);return}if(r==="."&&t.shiftKey&&t.altKey&&!t.ctrlKey&&!t.metaKey){t.preventDefault(),e.nudgeSelection(n);return}}if((r==="+"||r==="=")&&!o){t.preventDefault(),e.zoomWorkWindow(.8);return}if(r==="-"&&!o){t.preventDefault(),e.zoomWorkWindow(1.25);return}if((r==="+"||r==="=")&&(t.ctrlKey||t.metaKey)){t.preventDefault();let a=(e.overviewStart+e.overviewEnd)/2;e.zoomOverview(.8,a);return}if(r==="-"&&(t.ctrlKey||t.metaKey)){t.preventDefault();let a=(e.overviewStart+e.overviewEnd)/2;e.zoomOverview(1.25,a);return}if(r==="0"&&(t.ctrlKey||t.metaKey)){t.preventDefault(),d(e.duration)&&e.duration>0&&(e.workStart=0,e.workEnd=e.duration,e.resetOverviewZoom(),e.render());return}if(/^[0-9]$/.test(r)&&d(e.duration)&&!o){t.preventDefault();let c=parseInt(r)*10/100*e.duration;e.video&&(e.video.currentTime=c,e.workHeadTime=c,e.renderPlayheads(),e.updateTransportTime())}}executeKeybindingAction(t){let e=this.editor;switch(t){case"set_in_point":e.btnSetIn?.click();break;case"set_out_point":e.btnSetOut?.click();break;case"create_clip":e.createClipFromRange();break;case"play_pause":e.transportTogglePlay();break;case"seek_back":e.seekRelative(-10);break;case"seek_forward":e.seekRelative(10);break;case"prev_frame":e.transportPrevFrame();break;case"next_frame":e.transportNextFrame();break;default:break}}};var Z=class{constructor(t){this.editor=t}renderOverview(){let t=this.editor;if(!t.overviewLayer||!d(t.duration)||t.duration<=0)return;t.ensureOverviewWindow();let e=t.overviewLayer;e.innerHTML="";let i=p=>{let y=document.createElement("div");return y.className=p,y},r=t.overviewStart,o=t.overviewEnd,n=o-r;if(!d(n)||n<=0)return;let a=p=>(p-r)/n*100,c=t.seek?.manifest&&t.showFilmstrip?40:0;if(t.waveform?.peaks&&t.waveform?.manifest){let p=document.createElement("canvas");p.className="absolute inset-0 pointer-events-none",p.style.width="100%",p.style.height="100%",p.style.opacity="0.7",p.style.zIndex="0";let y=window.devicePixelRatio||1;p.width=Math.max(1,Math.floor(e.clientWidth*y)),p.height=Math.max(1,Math.floor(e.clientHeight*y)),t.drawWaveformToCanvas(p,r,o),e.appendChild(p)}if(c>0){let p=i("absolute left-0 right-0 top-0 pointer-events-none overflow-hidden");p.style.height=`${c}px`,p.style.zIndex="2",e.appendChild(p),t.seekThumbs.renderRow("overview",p,r,o,e.clientWidth)}let l=i("absolute inset-0");if(l.style.zIndex="1",e.appendChild(l),(t.clips||[]).forEach(p=>{if(!d(p.startTs)||!d(p.endTs)||p.endTs<=p.startTs||p.endTs<=r||p.startTs>=o)return;let y=a(p.startTs),k=(p.endTs-p.startTs)/n*100,S=p.id,w=t.selectedClipId&&S===t.selectedClipId,b=i("absolute top-0 bottom-0");b.style.left=`${y}%`,b.style.width=`${k}%`,b.dataset.clipBar="overview",S&&(b.dataset.clipId=S);let T=(w?t.getLiveClipColor():null)||p.color.trim();T?(b.style.background=T,b.style.opacity=w?"0.6":"0.4",w&&(b.style.borderLeft=`2px solid ${T}`,b.style.borderRight=`2px solid ${T}`,b.style.boxSizing="border-box")):(b.style.background="rgba(255,255,255,0.15)",w&&(b.style.borderLeft="2px solid rgba(255,255,255,0.6)",b.style.borderRight="2px solid rgba(255,255,255,0.6)",b.style.boxSizing="border-box")),p.title&&(b.title=p.title),b.addEventListener("click",C=>{C.stopPropagation();let x=R(t.overviewEl,C,t.overviewStart,t.overviewEnd);t.workHeadTime=m(x,0,t.duration),t.selectClip(p,x)}),l.appendChild(b)}),(t.markers||[]).forEach(p=>{if(!d(p.timestamp)||p.timestamp<0||p.timestamp>t.duration)return;let y=p.timestamp;if(y>=o)return;let k=p.color.trim(),S=p.duration;if(d(S)&&S>0){let w=Math.min(y+S,t.duration);if(w<=r)return;let b=a(y),T=(w-y)/n*100,C=i("absolute top-0 bottom-0 bg-white/20");C.style.left=`${b}%`,C.style.width=`${T}%`,k&&(C.style.background=k,C.style.opacity="0.35"),C.dataset.markerEl="",C.addEventListener("click",x=>{x.stopPropagation(),t.workHeadTime=m(y,0,t.duration),t.video&&(t.video.currentTime=y)}),l.appendChild(C)}else{if(y<r)return;let w=a(y),b=i("absolute top-0 bottom-0 w-[2px] bg-white/40");b.style.left=`${w}%`,k&&(b.style.background=k,b.style.opacity="0.8"),b.dataset.markerEl="",b.addEventListener("click",T=>{T.stopPropagation(),t.workHeadTime=m(y,0,t.duration),t.video&&(t.video.currentTime=y)}),l.appendChild(b)}}),d(t.inPoint)&&d(t.outPoint)){let p=m(Math.min(t.inPoint,t.outPoint),0,t.duration),y=m(Math.max(t.inPoint,t.outPoint),0,t.duration);if(y>p&&y>r&&p<o){let k=a(p),S=(y-p)/n*100,w=i("absolute top-0 bottom-0 bg-white/20 border-y-2 border-white/40");if(w.style.left=`${k}%`,w.style.width=`${S}%`,t.selectedClipId){let b=this.findClipByID(t.selectedClipId),T=t.getLiveClipColor()||(b?.color??b?.Color??"").toString().trim();if(T){w.style.background=T,w.style.opacity="0.2";let C=getComputedStyle(e).backgroundColor||"rgb(10,10,10)";w.style.borderColor=et(T,C,.2)}}w.style.pointerEvents="none",l.appendChild(w)}}let h=a(t.workStart),u=(t.workEnd-t.workStart)/n*100,f=i("absolute top-0 bottom-0 border-2 border-white/40 bg-white/5");f.style.left=`${h}%`,f.style.width=`${u}%`,f.style.pointerEvents="none";let v=i("absolute top-0 bottom-0 w-2 bg-white/10 border-r-2 border-white/20");v.style.left="0",v.style.transform="translateX(-50%)",v.style.pointerEvents="none";let g=i("absolute top-0 bottom-0 w-2 bg-white/10 border-l-2 border-white/20");g.style.right="0",g.style.transform="translateX(50%)",g.style.pointerEvents="none",f.appendChild(v),f.appendChild(g),l.appendChild(f);let E=i("absolute right-2 top-1 text-[10px] text-white/40 font-mono");if(E.textContent=`${N(r)}\u2013${N(o)}`,l.appendChild(E),t.isOverviewZoomed()){let p=i("absolute left-0 right-0 bottom-0 h-1 bg-white/5");p.style.zIndex="10";let y=r/t.duration*100,k=n/t.duration*100,S=i("absolute top-0 bottom-0 bg-white/30 rounded-sm");S.style.left=`${y}%`,S.style.width=`${k}%`,p.appendChild(S),e.appendChild(p)}}getOverviewWorkWindowHit(t){let e=this.editor;if(!e.overviewEl||!d(e.duration)||e.duration<=0)return"seek";let i=e.overviewEnd-e.overviewStart;if(!d(i)||i<=0)return"seek";let r=e.overviewEl.getBoundingClientRect(),o=m(t.clientX-r.left,0,r.width),n=(e.workStart-e.overviewStart)/i*r.width,a=(e.workEnd-e.overviewStart)/i*r.width,c=8,l=Math.abs(o-n)<=c,h=Math.abs(o-a)<=c,u=o>n+c&&o<a-c;return l?"resize-left":h?"resize-right":u?"move":"seek"}renderWork(){let t=this.editor;if(!t.workLayer||!d(t.duration)||t.duration<=0)return;let e=t.workLayer;e.innerHTML="";let i=t.workEnd-t.workStart;if(!d(i)||i<=0)return;let r=c=>{let l=document.createElement("div");return l.className=c,l},o=t.seek?.manifest&&t.showFilmstrip?56:0;if(o>0){let c=r("absolute left-0 right-0 top-0 pointer-events-none overflow-hidden");c.style.height=`${o}px`,e.appendChild(c),t.seekThumbs.renderRow("work",c,t.workStart,t.workEnd,e.clientWidth)}let n=r("absolute left-0 right-0 bottom-0");if(n.style.top=`${o}px`,e.appendChild(n),t.waveform?.peaks&&t.waveform?.manifest){let c=document.createElement("canvas");c.className="absolute inset-0 w-full h-full pointer-events-none",c.style.opacity="0.5";let l=window.devicePixelRatio||1;c.width=Math.max(1,Math.floor(e.clientWidth*l)),c.height=Math.max(1,Math.floor((e.clientHeight-o)*l)),t.drawWaveformToCanvas(c,t.workStart,t.workEnd),n.appendChild(c)}if((t.clips||[]).forEach(c=>{if(!d(c.startTs)||!d(c.endTs)||c.endTs<=c.startTs||c.endTs<t.workStart||c.startTs>t.workEnd)return;let l=m(c.startTs,t.workStart,t.workEnd),h=m(c.endTs,t.workStart,t.workEnd);if(h<=l)return;let u=(l-t.workStart)/i*100,f=(h-l)/i*100,v=!!(c.id&&c.id===t.selectedClipId),g=r("absolute top-0 bottom-0");g.style.left=`${u}%`,g.style.width=`${f}%`,g.dataset.clipBar="work",c.id&&(g.dataset.clipId=c.id);let E=(v?t.getLiveClipColor():null)||c.color.trim();E?(g.style.background=E,g.style.opacity=v?"0.6":"0.4"):g.style.background="rgba(255,255,255,0.15)",v&&(g.style.zIndex="1",g.style.borderTop="2px solid rgba(255,255,255,0.6)",g.style.borderBottom="2px solid rgba(255,255,255,0.6)",t.editMode&&(g.style.borderTop="2px solid rgba(255,200,50,0.8)",g.style.borderBottom="2px solid rgba(255,200,50,0.8)")),g.addEventListener("click",p=>{if(p.stopPropagation(),t.suppressNextWorkClick){t.suppressNextWorkClick=!1;return}if(v)return;let y=R(t.workEl,p,t.workStart,t.workEnd);t.selectClip(c,y)}),n.appendChild(g)}),(t.markers||[]).forEach(c=>{if(!d(c.timestamp))return;let l=c.timestamp,h=c.color.trim(),u=c.duration;if(d(u)&&u>0){let g=l,E=l+u;if(E<t.workStart||g>t.workEnd)return;let p=m(g,t.workStart,t.workEnd),y=m(E,t.workStart,t.workEnd);if(y<=p)return;let k=(p-t.workStart)/i*100,S=(y-p)/i*100,w=r("absolute top-0 bottom-0 bg-white/20");w.style.left=`${k}%`,w.style.width=`${S}%`,h&&(w.style.background=h,w.style.opacity="0.35"),w.dataset.markerEl="",w.addEventListener("click",b=>{b.stopPropagation(),t.workHeadTime=m(l,0,t.duration),t.video&&(t.video.currentTime=l)}),n.appendChild(w);return}if(l<t.workStart||l>t.workEnd)return;let f=(l-t.workStart)/i*100,v=r("absolute top-0 bottom-0 w-[2px] bg-white/30");v.style.left=`${f}%`,h&&(v.style.background=h,v.style.opacity="0.8"),v.dataset.markerEl="",v.addEventListener("click",g=>{g.stopPropagation(),t.workHeadTime=m(l,0,t.duration),t.video&&(t.video.currentTime=l)}),n.appendChild(v)}),d(t.inPoint)&&d(t.outPoint)){let c=m(Math.min(t.inPoint,t.outPoint),t.workStart,t.workEnd),l=m(Math.max(t.inPoint,t.outPoint),t.workStart,t.workEnd);if(l>c){let h=(c-t.workStart)/i*100,u=(l-c)/i*100,f=r("absolute top-0 bottom-0 bg-white/15 border-2 border-white/30");if(f.style.left=`${h}%`,f.style.width=`${u}%`,f.style.pointerEvents="none",t.selectedClipId){let E=this.findClipByID(t.selectedClipId),p=t.getLiveClipColor()||(E?.color??E?.Color??"").toString().trim();if(p){f.style.background=p,f.style.opacity="0.25";let y=getComputedStyle(e).backgroundColor||"rgb(10,10,10)";f.style.borderColor=et(p,y,.25)}}let v=r("absolute top-0 bottom-0 w-2 bg-white/10 border-r-2 border-white/20");v.style.left="0",v.style.transform="translateX(-50%)",v.style.pointerEvents="none";let g=r("absolute top-0 bottom-0 w-2 bg-white/10 border-l-2 border-white/20");g.style.right="0",g.style.transform="translateX(50%)",g.style.pointerEvents="none",f.appendChild(v),f.appendChild(g),n.appendChild(f)}}let a=r("absolute right-2 top-1 text-[10px] text-white/40 font-mono");a.textContent=`${N(t.workStart)}\u2013${N(t.workEnd)}`,n.appendChild(a)}findClipByID(t){return!t||typeof t!="string"?null:(this.editor.clips||[]).find(e=>e?.id===t)||null}getTrimHitForBar(t,e){if(!t)return"none";let i=t.getBoundingClientRect(),r=m(e.clientX-i.left,0,i.width),o=8;return r<=o?"start":r>=i.width-o?"end":"none"}renderPlayheads(){let t=this.editor;if(!t.video||!d(t.duration)||t.duration<=0)return;let e=t.video.currentTime;if(!d(e)||e<0)return;let i=(n,a,c,l)=>{if(!n)return;let h=n.querySelector(`[${c}]`);h||(h=document.createElement("div"),c==="data-cut-playhead"?h.dataset.cutPlayhead="1":c==="data-cut-workhead"&&(h.dataset.cutWorkhead="1"),h.className=l,n.appendChild(h)),h.style.left=`${m(a,0,100)}%`,h.style.display="block"},r=t.overviewEnd-t.overviewStart;d(r)&&r>0&&(i(t.overviewLayer,(e-t.overviewStart)/r*100,"data-cut-playhead","absolute top-0 bottom-0 w-[2px] bg-white"),d(t.workHeadTime)&&i(t.overviewLayer,(t.workHeadTime-t.overviewStart)/r*100,"data-cut-workhead","absolute top-0 bottom-0 w-[2px] bg-white/60"));let o=t.workEnd-t.workStart;if(d(o)&&o>0&&(i(t.workLayer,(e-t.workStart)/o*100,"data-cut-playhead","absolute top-0 bottom-0 w-[2px] bg-white"),d(t.workHeadTime))){let n=(t.workHeadTime-t.workStart)/o*100,a=m(n,0,100);i(t.workLayer,a,"data-cut-workhead","absolute top-0 bottom-0 w-[2px] bg-white/60");let c=t.workLayer?.querySelector("[data-cut-workhead]");c&&(n<0||n>100)&&(c.style.display="none")}}};var ft={selectClipById(s){if(!s||!this.clips)return;let t=this.clips.find(e=>e.id===s);t&&this.selectClip(t,t.startTs)},selectClip(s,t){let e=s?.id;if(!e||typeof e!="string")return;let i=s.startTs,r=s.endTs;if(d(i)&&d(r)&&r>i){this.inPoint=i,this.outPoint=r;let o=Math.min(10,(r-i)*.2);d(this.duration)&&this.duration>0&&(this.workStart=m(i-o,0,this.duration),this.workEnd=m(r+o,0,this.duration))}this.selectedClipId=e,this.editMode=!0,this.pendingClipStart=i,this.pendingClipEnd=r,this.pendingClipDirty=!1,this.video&&d(t)&&(this.workHeadTime=m(t,0,this.duration||t),this.video.currentTime=m(t,0,this.duration||t)),this.render(),this.queueInspectorFocus()},queueInspectorFocus(){this._inspectorFocusToken=(this._inspectorFocusToken||0)+1;let s=this._inspectorFocusToken,t=e=>{if(s!==this._inspectorFocusToken)return;let i=document.querySelector("[data-cut-clip-form]");if(!i||i.classList.contains("hidden")){e>0&&setTimeout(()=>t(e-1),60);return}let r=document.activeElement;if(r&&i.contains(r))return;let o=i.querySelector('input, textarea, select, [contenteditable="true"]');if(o&&typeof o.focus=="function"){try{o.focus({preventScroll:!0})}catch{o.focus()}return}e>0&&setTimeout(()=>t(e-1),60)};t(8)},clearSelectedClip(){this.selectedClipId=null,this.editMode=!1,this.pendingClipStart=null,this.pendingClipEnd=null,this.pendingClipDirty=!1,this.drag&&this.drag.type==="clip-trim"&&this.resetDrag(),this.setSignalInput("[data-cut-clip-dirty]",!1),this.setSignalInput("[data-cut-clip-start-ts]",0),this.setSignalInput("[data-cut-clip-end-ts]",0);let s=window.__dsAPI;s&&s.mergePatch({_selectedClipId:"",_filterStack:[]}),this.render()},enterEditMode(){this.selectedClipId&&(this.editMode=!0,this.render())},exitEditMode(){this.editMode=!1,this.render()},nudgeInPoint(s){if(!d(this.inPoint))return;let t=m(this.inPoint+s,0,this.duration||1/0);d(this.outPoint)&&t>=this.outPoint||(this.inPoint=t,this.markPendingClipTiming(this.inPoint,this.outPoint),this.render())},nudgeOutPoint(s){if(!d(this.outPoint))return;let t=m(this.outPoint+s,0,this.duration||1/0);d(this.inPoint)&&t<=this.inPoint||(this.outPoint=t,this.markPendingClipTiming(this.inPoint,this.outPoint),this.render())},nudgeSelection(s){if(!d(this.inPoint)||!d(this.outPoint))return;let t=this.duration||1/0,e=this.inPoint+s,i=this.outPoint+s;e<0&&(i-=e,e=0),i>t&&(e-=i-t,i=t),e<0&&(e=0),this.inPoint=e,this.outPoint=i,this.markPendingClipTiming(this.inPoint,this.outPoint),this.render()},async splitClipAtPlayhead(){if(!this.selectedClipId||!this.editMode)return;let s=this.video?.currentTime;if(!d(s))return;let t=this.inPoint,e=this.outPoint;if(!d(t)||!d(e))return;let i=this.videoFps>0?1/this.videoFps:1/30;if(s<=t+i||s>=e-i){console.warn("Split point must be inside the clip bounds (at least 1 frame from edges)");return}try{let r=await fetch(`/api/clips/${encodeURIComponent(this.selectedClipId)}/split`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({at:s})});if(!r.ok){let o=await r.text();console.error("Split failed:",o);return}this.exitEditMode(),this.clearSelectedClip(),await this.loadClipsForTimeline(),this.render()}catch(r){console.error("Split error:",r)}},async createClipFromRange(){if(!this.videoID||!d(this.inPoint)||!d(this.outPoint))return;let s=Math.min(this.inPoint,this.outPoint),t=Math.max(this.inPoint,this.outPoint);if(!d(s)||!d(t)||t<=s)return;let e=document.querySelector("[data-cut-create-start]"),i=document.querySelector("[data-cut-create-end]"),r=document.querySelector("[data-cut-create-submit]");!e||!i||!r||(e.value=s,i.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("input",{bubbles:!0})),r.click())},markPendingClipTiming(s,t){this.pendingClipStart=s,this.pendingClipEnd=t,this.pendingClipDirty=!0,this.setSignalInput("[data-cut-clip-start-ts]",s),this.setSignalInput("[data-cut-clip-end-ts]",t),this.setSignalInput("[data-cut-clip-dirty]",!0),this.scheduleAutoSave()},scheduleAutoSave(){clearTimeout(this._autoSaveTimer);let s=window.__dsAPI;s&&s.getPath("_localAutoSave")&&(this._autoSaveTimer=setTimeout(()=>{let t=document.querySelector("[data-cut-autosave-trigger]");t&&t.click()},600))},setSignalInput(s,t){let e=document.querySelector(s);if(!e)return;let i=typeof t=="boolean"?t?"true":"":String(t);e.value!==i&&(e.value=i,e.dispatchEvent(new Event("input",{bubbles:!0})))}};var mt={getWorkSelectionHit(s){if(!this.workEl||!s)return"set";let t=this.getSelectionRange();if(!t)return"set";let e=m(t.start,this.workStart,this.workEnd),i=m(t.end,this.workStart,this.workEnd);if(!d(e)||!d(i)||i<=e)return"set";let r=this.workEl.getBoundingClientRect(),o=m(s.clientX-r.left,0,r.width),n=this.workEnd-this.workStart;if(!d(n)||n<=0)return"set";let a=(e-this.workStart)/n*r.width,c=(i-this.workStart)/n*r.width,l=8,h=Math.abs(o-a)<=l,u=Math.abs(o-c)<=l,f=o>a+l&&o<c-l;return h?"resize-left":u?"resize-right":f?"move":"set"},ensureDefaultWorkWindow(){if(!d(this.duration)||this.duration<=0||d(this.workEnd)&&this.workEnd>this.workStart)return;let s=m(this.duration*.02,60,300),t=d(this.video?.currentTime)?this.video.currentTime:0,e=m(t-s/2,0,Math.max(0,this.duration-s)),i=m(e+s,0,this.duration);this.workStart=e,this.workEnd=i,this.renderRange()},setWorkWindow(s,t){if(!d(this.duration)||this.duration<=0)return;let e=m(Math.min(s,t),0,this.duration),i=m(Math.max(s,t),0,this.duration),r=5;this.workStart=e,this.workEnd=Math.max(i,e+r),this.workEnd>this.duration&&(this.workEnd=this.duration,this.workStart=Math.max(0,this.workEnd-r)),this.render()},panWorkWindow(s){if(!d(this.duration)||this.duration<=0)return;let t=this.workEnd-this.workStart,e=t*s,i=m(this.workStart+e,0,Math.max(0,this.duration-t));this.workStart=i,this.workEnd=i+t,this.render()},zoomWorkWindow(s){if(!d(this.duration)||this.duration<=0)return;let t=(this.workStart+this.workEnd)/2,e=m((this.workEnd-this.workStart)*s,1,this.duration),i=m(t-e/2,0,Math.max(0,this.duration-e));this.workStart=i,this.workEnd=i+e,this.render()},ensureOverviewWindow(){!d(this.duration)||this.duration<=0||d(this.overviewEnd)&&this.overviewEnd>this.overviewStart||(this.overviewStart=0,this.overviewEnd=this.duration)},zoomOverview(s,t){if(!d(this.duration)||this.duration<=0)return;this.ensureOverviewWindow();let e=d(t)?t:(this.overviewStart+this.overviewEnd)/2,i=Math.max(5,this.duration*.01),r=m((this.overviewEnd-this.overviewStart)*s,i,this.duration),o=m(e-r/2,0,Math.max(0,this.duration-r));this.overviewStart=o,this.overviewEnd=o+r,this.render()},panOverview(s){if(!d(this.duration)||this.duration<=0)return;this.ensureOverviewWindow();let t=this.overviewEnd-this.overviewStart,e=t*s,i=m(this.overviewStart+e,0,Math.max(0,this.duration-t));this.overviewStart=i,this.overviewEnd=i+t,this.render()},resetOverviewZoom(){!d(this.duration)||this.duration<=0||(this.overviewStart=0,this.overviewEnd=this.duration,this.render())},isOverviewZoomed(){return!d(this.duration)||this.duration<=0?!1:this.overviewStart>.01||this.duration-this.overviewEnd>.01},renderRange(){if(!this.rangeEl)return;let s=t=>d(t)?t.toFixed(2):"--";this.rangeEl.textContent=`In: ${s(this.inPoint)}  Out: ${s(this.outPoint)}  Work: ${N(this.workStart)}\u2013${N(this.workEnd)}`},getSelectionRange(){if(!d(this.inPoint)||!d(this.outPoint))return null;let s=Math.min(this.inPoint,this.outPoint),t=Math.max(this.inPoint,this.outPoint);if(!d(s)||!d(t)||t<=s)return null;let e=d(this.duration)&&this.duration>0?this.duration:null;return{start:m(s,0,e??s),end:m(t,0,e??t)}}};var vt={handleDocumentMouseMove(s){let t=this.drag;if(t.type==="work-pan"&&this.workEl){let e=s.clientX-t.startX,i=this.workEl.getBoundingClientRect();if(i.width>0&&d(t.origStart)&&d(t.origEnd)){let r=t.origEnd-t.origStart,o=-(e/i.width)*r,n=Math.max(0,this.duration-r),a=m(t.origStart+o,0,n);this.workStart=a,this.workEnd=a+r,this.render()}return}if(t.type==="overview-pan"&&this.overviewEl){let e=s.clientX-t.startX,i=this.overviewEl.getBoundingClientRect();if(i.width>0&&d(t.origStart)&&d(t.origEnd)){let r=t.origEnd-t.origStart,o=-(e/i.width)*r,n=Math.max(0,this.duration-r),a=m(t.origStart+o,0,n);this.overviewStart=a,this.overviewEnd=a+r,this.render()}return}if(t.type==="clip-trim"&&this.workEl&&d(this.duration)&&this.duration>0){let e=this.snapTime(R(this.workEl,s,this.workStart,this.workEnd),s),i=this.findClipByID(t.clipId);if(!i||!t.trimSide||!d(t.origStart)||!d(t.origEnd)||t.origEnd<=t.origStart)return;let r=.05;if(t.trimSide==="start"){let o=m(e,0,Math.max(0,t.origEnd-r));Math.abs(o-t.origStart)>1e-4&&(t.didMove=!0),i.startTs=o,this.inPoint=o,this.outPoint=t.origEnd,this.render()}else if(t.trimSide==="end"){let o=m(e,Math.min(this.duration,t.origStart+r),this.duration);Math.abs(o-t.origEnd)>1e-4&&(t.didMove=!0),i.endTs=o,this.inPoint=t.origStart,this.outPoint=o,this.render()}return}if(t.type==="overview"&&this.overviewEl){let e=d(t.startX)?Math.abs(s.clientX-t.startX):0,i=d(t.startY)?Math.abs(s.clientY-t.startY):0,r=8;if(!t.didDrag){if(e<=r&&i<=r)return;t.didDrag=!0,this.suppressNextOverviewClick=!0}let o=R(this.overviewEl,s,this.overviewStart,this.overviewEnd);if(t.subMode==="seek"){let n=m(o,0,this.duration);this.workHeadTime=n,this.video&&(this.video.currentTime=n);return}if(t.subMode==="set")this.setWorkWindow(t.anchor,o);else if(t.subMode==="pan"&&d(t.anchor)&&d(t.origStart)&&d(t.origEnd)){let n=o-t.anchor,a=t.origEnd-t.origStart,c=m(t.origStart+n,0,Math.max(0,this.duration-a));this.workStart=c,this.workEnd=c+a,this.render()}else if((t.subMode==="resize-left"||t.subMode==="resize-right")&&d(t.origStart)&&d(t.origEnd))if(t.subMode==="resize-left"){let a=m(o,0,Math.max(0,t.origEnd-5));this.workStart=a,this.workEnd=t.origEnd,this.workEnd-this.workStart<5&&(this.workStart=Math.max(0,this.workEnd-5)),this.render()}else{let a=m(o,Math.min(this.duration,t.origStart+5),this.duration);this.workStart=t.origStart,this.workEnd=a,this.workEnd-this.workStart<5&&(this.workEnd=Math.min(this.duration,this.workStart+5)),this.render()}}if(t.type==="work-pending"&&this.workEl&&d(t.startX)&&d(t.startY)&&d(t.anchor)){let e=Math.abs(s.clientX-t.startX),i=Math.abs(s.clientY-t.startY);if(e>3||i>3){let r=t.anchor,o=t.hitTest||"set";if(this.drag={type:"selection",subMode:o,anchor:r,startX:t.startX,startY:t.startY,origStart:null,origEnd:null,clipId:null,trimSide:null,hitTest:null,didDrag:!0,didMove:!1},this.suppressNextWorkClick=!0,o==="set"?D("crosshair"):o==="move"?D("grabbing"):(o==="resize-left"||o==="resize-right")&&D("ew-resize"),o==="move"||o==="resize-left"||o==="resize-right"){let n=this.getSelectionRange();n?(this.drag.origStart=n.start,this.drag.origEnd=n.end):(this.drag.subMode="set",this.inPoint=r,this.outPoint=r,this.render())}else this.inPoint=r,this.outPoint=r,this.render()}}if(t.type==="selection"&&this.workEl){let e=this.snapTime(R(this.workEl,s,this.workStart,this.workEnd),s),i=t.subMode||"set",r=.05;if(i==="set")this.inPoint=t.anchor,this.outPoint=e,this.render();else if(i==="move"){if(!d(t.anchor)||!d(t.origStart)||!d(t.origEnd))return;let o=t.origEnd-t.origStart;if(!d(o)||o<=0)return;let n=e-t.anchor,a=d(this.duration)&&this.duration>0?this.duration:1/0,c=m(t.origStart+n,0,Math.max(0,a-o)),l=m(c+o,0,a);this.inPoint=c,this.outPoint=l,this.render()}else if(i==="resize-left"){if(!d(t.origEnd))return;let o=d(this.duration)&&this.duration>0?this.duration:1/0,n=m(t.origEnd,0,o),a=m(e,0,Math.max(0,n-r));this.inPoint=a,this.outPoint=n,this.render()}else if(i==="resize-right"){if(!d(t.origStart))return;let o=d(this.duration)&&this.duration>0?this.duration:1/0,n=m(t.origStart,0,o),a=m(e,Math.min(o,n+r),o);this.inPoint=n,this.outPoint=a,this.render()}if(this.editMode&&this.selectedClipId){let o=this.findClipByID(this.selectedClipId);if(o&&d(this.inPoint)&&d(this.outPoint)){let n=Math.min(this.inPoint,this.outPoint),a=Math.max(this.inPoint,this.outPoint);a>n&&(o.startTs=n,o.endTs=a,t.didMove=!0)}}}},handleDocumentMouseUp(){let s=this.drag;if(s.type==="work-pan"||s.type==="overview-pan"){this.resetDrag();return}if(s.type==="overview"){if(s.didDrag&&(this.suppressNextOverviewClick=!0),!s.didDrag&&s.subMode!=="set"&&this.video&&d(s.anchor)&&d(this.duration)&&this.duration>0){let t=m(s.anchor,0,this.duration);this.workHeadTime=t,this.video.currentTime=t}this.resetDrag();return}if(s.type==="selection"){let t=s.didMove;if(this.resetDrag(),this.selectedClipId&&t){let e=this.findClipByID(this.selectedClipId);d(e?.startTs)&&d(e?.endTs)&&e.endTs>e.startTs&&this.markPendingClipTiming(e.startTs,e.endTs)}return}if(s.type==="clip-trim"){let t=s.clipId,e=this.findClipByID(t),i=e?.startTs,r=e?.endTs,o=s.didMove;this.resetDrag(),o&&(this.suppressNextWorkClick=!0),o&&typeof t=="string"&&d(i)&&d(r)&&r>i&&this.markPendingClipTiming(i,r);return}s.type==="work-pending"&&this.resetDrag()}};var gt={_attachVideoListeners(){this.video&&(this.video.addEventListener("loadedmetadata",()=>{this.duration=this.video.duration,this.overviewStart=0,this.overviewEnd=this.duration,this.ensureDefaultWorkWindow(),d(this.video.currentTime)?this.workHeadTime=this.video.currentTime:this.workHeadTime=0,this.render()}),this.video.addEventListener("timeupdate",()=>{this.renderPlayheads(),this.updateTransportTime(),this.handleSelectionPlaybackTick()}),this.video.addEventListener("play",()=>{this.renderPlaySelectionButton(),this.updateTransportPlayButton()}),this.video.addEventListener("pause",()=>{this.renderPlaySelectionButton(),this.updateTransportPlayButton()}),this.video.addEventListener("ended",()=>{if(this.transportLoopEnabled){this.video.currentTime=0,this.video.play().catch(()=>{});return}this.renderPlaySelectionButton(),this.updateTransportPlayButton()}))},_attachOverviewListeners(){this.overviewEl&&(this.overviewEl.addEventListener("click",s=>{if(this.suppressNextOverviewClick){this.suppressNextOverviewClick=!1;return}if(!this.video||!d(this.duration)||this.duration<=0)return;let t=R(this.overviewEl,s,this.overviewStart,this.overviewEnd);this.workHeadTime=m(t,0,this.duration),this.video.currentTime=m(t,0,this.duration)}),this.overviewEl.addEventListener("auxclick",s=>{s.button===1&&s.preventDefault()}),this.overviewEl.addEventListener("mousedown",s=>{if(!d(this.duration)||this.duration<=0)return;if(s.preventDefault(),s.button===1||s.button===0&&s.altKey&&!s.shiftKey){this.drag={type:"overview-pan",subMode:null,anchor:null,startX:s.clientX,startY:null,origStart:this.overviewStart,origEnd:this.overviewEnd,clipId:null,trimSide:null,hitTest:null,didDrag:!1,didMove:!1},this.suppressNextOverviewClick=!0,D("grabbing");return}let t=R(this.overviewEl,s,this.overviewStart,this.overviewEnd);this.workHeadTime=m(t,0,this.duration);let e,i,r;if(s.shiftKey)e="set",this.setWorkWindow(t,t),i=null,r=null,this.suppressNextOverviewClick=!0;else{let o=this.timeline.getOverviewWorkWindowHit(s);o==="resize-left"?(e="resize-left",i=this.workStart,r=this.workEnd):o==="resize-right"?(e="resize-right",i=this.workStart,r=this.workEnd):o==="move"?(e="pan",i=this.workStart,r=this.workEnd):(e="seek",i=null,r=null)}this.drag={type:"overview",subMode:e,anchor:t,startX:s.clientX,startY:s.clientY,origStart:i,origEnd:r,clipId:null,trimSide:null,hitTest:null,didDrag:!1,didMove:!1},e==="set"||e==="seek"?D("crosshair"):e==="pan"?D("grabbing"):(e==="resize-left"||e==="resize-right")&&D("ew-resize")}),this.overviewEl.addEventListener("mousemove",s=>{if(this.seekThumbs.queueTooltipUpdate("overview",s),this.drag.type!=="none")return;if(s.shiftKey){this.overviewPointerMode="set",this.overviewEl.style.cursor="crosshair";return}let t=this.timeline.getOverviewWorkWindowHit(s);this.overviewPointerMode=t,t==="resize-left"||t==="resize-right"?this.overviewEl.style.cursor="ew-resize":s.target.closest("[data-clip-bar]")?this.overviewEl.style.cursor="pointer":s.target.closest("[data-marker-el]")?this.overviewEl.style.cursor="pointer":t==="move"?this.overviewEl.style.cursor="grab":this.overviewEl.style.cursor="crosshair"}),this.overviewEl.addEventListener("mouseleave",()=>this.seekThumbs.hideTooltip("overview")),this.overviewEl.addEventListener("wheel",s=>{if(s.preventDefault(),s.ctrlKey||s.metaKey){let t=this.overviewEl.getBoundingClientRect(),e=m(s.clientX-t.left,0,t.width),i=t.width>0?e/t.width:.5,r=this.overviewEnd-this.overviewStart,o=this.overviewStart+i*r,n=s.deltaY>0?1.15:.87;this.zoomOverview(n,o)}else if(s.shiftKey||s.deltaX!==0){let t=s.deltaX!==0?s.deltaX:s.deltaY;this.panOverview(t>0?.05:-.05)}else{let t=s.deltaY>0?1.15:.87;this.zoomWorkWindow(t)}},{passive:!1}))},_attachWorkListeners(){this.workEl&&(this.workEl.addEventListener("mousemove",s=>{if(this.seekThumbs.queueTooltipUpdate("work",s),this.drag.type!=="none"&&this.drag.type!=="work-pending")return;let t=s.target.closest("[data-clip-bar]");if(t&&t.dataset.clipId===this.selectedClipId){let i=this.getTrimHitForBar(t,s);if(i==="start"||i==="end"){this.workEl.style.cursor="ew-resize";return}}let e=this.getWorkSelectionHit(s);e==="resize-left"||e==="resize-right"?this.workEl.style.cursor="ew-resize":e==="move"?this.workEl.style.cursor="grab":t?this.workEl.style.cursor="pointer":s.target.closest("[data-marker-el]")?this.workEl.style.cursor="pointer":this.workEl.style.cursor="crosshair"}),this.workEl.addEventListener("auxclick",s=>{s.button===1&&s.preventDefault()}),this.workEl.addEventListener("mousedown",s=>{if(!d(this.duration)||this.duration<=0)return;if(s.preventDefault(),s.button===1||s.button===0&&s.altKey){this.drag={type:"work-pan",subMode:null,anchor:null,startX:s.clientX,startY:null,origStart:this.workStart,origEnd:this.workEnd,clipId:null,trimSide:null,hitTest:null,didDrag:!1,didMove:!1},this.suppressNextWorkClick=!0,D("grabbing");return}let t=this.snapTime(R(this.workEl,s,this.workStart,this.workEnd),s);this.workHeadTime=m(t,0,this.duration);let e=s.target.closest("[data-clip-bar]");if(e){let i=e.dataset.clipId;if(i&&i===this.selectedClipId){let r=this.getTrimHitForBar(e,s);if(r==="start"||r==="end"){let o=this.findClipByID(i);if(o&&d(o.startTs)&&d(o.endTs)){this.drag={type:"clip-trim",subMode:null,anchor:t,startX:s.clientX,startY:s.clientY,origStart:o.startTs,origEnd:o.endTs,clipId:i,trimSide:r,hitTest:null,didDrag:!0,didMove:!1},this.suppressNextWorkClick=!0,D("ew-resize");return}}}}this.drag={type:"work-pending",subMode:null,anchor:t,startX:s.clientX,startY:s.clientY,origStart:null,origEnd:null,clipId:null,trimSide:null,hitTest:this.getWorkSelectionHit(s),didDrag:!1,didMove:!1}}),this.workEl.addEventListener("click",s=>{if(this.suppressNextWorkClick){this.suppressNextWorkClick=!1;return}if(!this.video||!d(this.duration)||this.duration<=0)return;let t=this.snapTime(R(this.workEl,s,this.workStart,this.workEnd),s);this.workHeadTime=m(t,0,this.duration),this.video.currentTime=m(t,0,this.duration)}),this.workEl.addEventListener("mouseleave",()=>this.seekThumbs.hideTooltip("work")),this.workEl.addEventListener("wheel",s=>{if(s.preventDefault(),s.ctrlKey||s.metaKey){let t=s.deltaY>0?1.15:.87;this.zoomWorkWindow(t)}else{let t=s.deltaX!==0?s.deltaX:s.deltaY;this.panWorkWindow(t>0?.05:-.05)}},{passive:!1}))},_attachButtons(){this.btnSetIn&&this.btnSetIn.addEventListener("click",()=>{let s=d(this.workHeadTime)?this.workHeadTime:this.video?.currentTime;if(d(s)){if(this.inPoint=m(s,0,this.duration||s),this.editMode&&this.selectedClipId){let t=this.findClipByID(this.selectedClipId);if(t){t.startTs=this.inPoint;let e=t.endTs;d(e)&&e>this.inPoint&&this.markPendingClipTiming(this.inPoint,e)}}this.renderRange(),this.render()}}),this.btnSetOut&&this.btnSetOut.addEventListener("click",()=>{let s=d(this.workHeadTime)?this.workHeadTime:this.video?.currentTime;if(d(s)){if(this.outPoint=m(s,0,this.duration||s),this.editMode&&this.selectedClipId){let t=this.findClipByID(this.selectedClipId);if(t){t.endTs=this.outPoint;let e=t.startTs;d(e)&&this.outPoint>e&&this.markPendingClipTiming(e,this.outPoint)}}this.renderRange(),this.render()}}),this.btnCreateClip&&this.btnCreateClip.addEventListener("click",()=>this.createClipFromRange()),this.btnPlaySelection&&(this.btnPlaySelection.addEventListener("click",()=>this.togglePlaySelection()),this.renderPlaySelectionButton()),this.btnLoop&&(this.btnLoop.addEventListener("click",()=>this.toggleLoop()),this.renderLoopButton()),this.btnPanLeft&&this.btnPanLeft.addEventListener("click",()=>this.panWorkWindow(-.1)),this.btnPanRight&&this.btnPanRight.addEventListener("click",()=>this.panWorkWindow(.1)),this.btnZoomIn&&this.btnZoomIn.addEventListener("click",()=>this.zoomWorkWindow(.8)),this.btnZoomOut&&this.btnZoomOut.addEventListener("click",()=>this.zoomWorkWindow(1.25)),this.btnToggleFilmstrip&&this.btnToggleFilmstrip.addEventListener("click",()=>this.toggleFilmstrip()),this.btnTransportStart&&this.btnTransportStart.addEventListener("click",()=>this.transportGoToStart()),this.btnTransportPrevFrame&&this.btnTransportPrevFrame.addEventListener("click",()=>this.transportPrevFrame()),this.btnTransportStop&&this.btnTransportStop.addEventListener("click",()=>this.transportStop()),this.btnTransportPlay&&this.btnTransportPlay.addEventListener("click",()=>this.transportTogglePlay()),this.btnTransportNextFrame&&this.btnTransportNextFrame.addEventListener("click",()=>this.transportNextFrame()),this.btnTransportEnd&&this.btnTransportEnd.addEventListener("click",()=>this.transportGoToEnd()),this.btnTransportLoop&&this.btnTransportLoop.addEventListener("click",()=>this.transportToggleLoop())}};(()=>{class s{constructor(i){this.root=i,this.videoID=i.dataset.videoId||null,this.videoFps=Number(i.dataset.videoFps||0)||0,this.video=i.querySelector("video"),this.keybindings={...ot,...nt()},this.keyMap=at(this.keybindings),this.overviewEl=document.querySelector("[data-cut-overview]"),this.overviewLayer=document.querySelector("[data-cut-overview-layer]"),this.workEl=document.querySelector("[data-cut-work]"),this.workLayer=document.querySelector("[data-cut-work-layer]"),this.rangeEl=document.querySelector("[data-cut-range]"),this.clipBankEl=document.querySelector("[data-cut-clip-bank]"),this.btnPanLeft=document.querySelector("[data-cut-pan-left]"),this.btnPanRight=document.querySelector("[data-cut-pan-right]"),this.btnZoomIn=document.querySelector("[data-cut-zoom-in]"),this.btnZoomOut=document.querySelector("[data-cut-zoom-out]"),this.btnToggleFilmstrip=document.querySelector("[data-cut-toggle-filmstrip]"),this.btnSetIn=document.querySelector("[data-cut-set-in]"),this.btnSetOut=document.querySelector("[data-cut-set-out]"),this.btnSaveClip=document.querySelector("[data-cut-save-clip]"),this.btnCreateClip=document.querySelector("[data-cut-create-clip]"),this.btnPlaySelection=document.querySelector("[data-cut-play-selection]"),this.btnLoop=document.querySelector("[data-cut-loop]"),this.btnTransportStart=document.querySelector("[data-cut-transport-start]"),this.btnTransportPrevFrame=document.querySelector("[data-cut-transport-prev-frame]"),this.btnTransportStop=document.querySelector("[data-cut-transport-stop]"),this.btnTransportPlay=document.querySelector("[data-cut-transport-play]"),this.btnTransportNextFrame=document.querySelector("[data-cut-transport-next-frame]"),this.btnTransportEnd=document.querySelector("[data-cut-transport-end]"),this.btnTransportLoop=document.querySelector("[data-cut-transport-loop]"),this.transportTimeEl=document.querySelector("[data-cut-transport-time]"),this.transportLoopEnabled=!1,this.cropOverlay=new Y(this),this.cropLayerEl=i.querySelector("[data-cut-crop-layer]"),this.cropSurfaceEl=i.querySelector("[data-cut-crop-surface]"),this.cropRectEl=i.querySelector("[data-cut-crop-rect]"),this.cropHandleEl=i.querySelector("[data-cut-crop-handle]"),this.cropOverlay.bindDOM(this.cropLayerEl,this.cropSurfaceEl,this.cropRectEl,this.cropHandleEl),this.selectedClipId=null,this.pendingClipStart=null,this.pendingClipEnd=null,this.pendingClipDirty=!1,this.editMode=!1,this.duration=NaN,this.workStart=0,this.workEnd=0,this.inPoint=null,this.outPoint=null,this.workHeadTime=NaN,this.loopEnabled=!1,this.stopAtOut=!1,this.markers=[],this.clips=[],this.clipBank=new G(this.videoID),this._wireClipBankEvents(),this.seekThumbs=new j(this),this.seek=this.seekThumbs,this.waveformRenderer=new X(this),this.waveform=this.waveformRenderer,this.showFilmstrip=localStorage.getItem("cut-editor-show-filmstrip")!=="false",this.overviewStart=0,this.overviewEnd=0,this.drag={type:"none"},this.overviewPointerMode="seek",this.suppressNextOverviewClick=!1,this.suppressNextWorkClick=!1,this.timeline=new Z(this),this.controls=new V(this),this.filterPreview=new A(this.video,this.video.parentElement),this.audioTools=new K(this.filterPreview.audioGraph),this.filterPreview.audioGraph.onRebuild=(r,o,n)=>{this.audioTools&&this.audioTools.tap(r,o,n)},this.attach(),this.load()}_wireClipBankEvents(){this.clipBank.addEventListener("clips:loaded",i=>{this.clips=i.detail.clips,this.render()}),this.clipBank.addEventListener("clip:selected",i=>{let{clip:r,seekTime:o}=i.detail;this.selectClip(r,o)}),this.clipBank.addEventListener("clip:deselected",()=>{this.selectedClipId=null,this.editMode=!1,this.pendingClipStart=null,this.pendingClipEnd=null,this.pendingClipDirty=!1,this.render()})}attach(){this._attachVideoListeners(),window.addEventListener("resize",()=>this.render()),this.initColorSwatches(),this.cropRectEl&&this.cropRectEl.addEventListener("pointerdown",i=>this.cropOverlay.beginDrag("move",i)),this.cropHandleEl&&this.cropHandleEl.addEventListener("pointerdown",i=>this.cropOverlay.beginDrag("resize",i)),this._attachOverviewListeners(),this._attachWorkListeners(),document.addEventListener("mousemove",i=>this.handleDocumentMouseMove(i)),document.addEventListener("mouseup",()=>this.handleDocumentMouseUp()),this._attachButtons(),document.addEventListener("keydown",i=>this.controls.handleKeyDown(i))}initColorSwatches(){this._colorSwatches||(this._colorSwatches=new U),this._colorSwatches.init()}async load(){this.videoID&&(await Promise.all([this.loadMarkers(),this.clipBank.reload(),this.seekThumbs.loadManifest(),this.loadWaveformAssets()]),this.render())}async loadSeekManifest(){return this.seekThumbs.loadManifest()}chooseSeekLevelForRange(i,r,o){return this.seekThumbs.chooseLevelForRange(i,r,o)}async loadWaveformAssets(){return this.waveformRenderer.loadAssets()}snapTime(i,r){if(!d(i)||r&&r.altKey)return i;let o=i,n=this.findNearestZeroCrossingTime(o,.5);d(n)&&(o=n);let a=d(this.videoFps)&&this.videoFps>0?this.videoFps:0;return a>0&&(o=Math.round(o*a)/a),m(o,0,this.duration||o)}findNearestZeroCrossingTime(i,r){return this.waveformRenderer.findNearestZeroCrossingTime(i,r)}drawWaveformToCanvas(i,r,o){!i||!d(r)||!d(o)||o<=r||this.waveformRenderer.drawToCanvas(i,r,o)}async loadMarkers(){try{let i=await fetch(`/api/videos/${encodeURIComponent(this.videoID)}/markers`,{headers:{Accept:"application/json"}});if(!i.ok)return;this.markers=(await i.json()).map(ht)}catch{}}async loadClipsForTimeline(){await this.clipBank.reload()}render(){this.ensureDefaultWorkWindow(),this.ensureOverviewWindow(),this.renderRange(),this.timeline.renderOverview(),this.timeline.renderWork(),this.timeline.renderPlayheads(),this.initColorSwatches(),this.updateCropSurfaceLayout(),this.renderCropOverlay()}get crop(){return this.cropOverlay.crop}get selectedCropId(){return this.cropOverlay.selectedCropId}loadCrop(i,r,o,n,a,c){this.cropOverlay.loadCrop(i,r,o,n,a,c)}updateCropSurfaceLayout(){this.cropOverlay.updateSurfaceLayout()}renderCropOverlay(){this.cropOverlay.renderOverlay()}getLiveClipColor(){if(!this.selectedClipId)return null;let i=window.__dsAPI;if(i){let n=i.getPath("clipColor");if(typeof n=="string"&&n.trim())return n.trim()}return document.querySelector('[data-bind="clipColor"]')?.value?.trim()||null}renderOverview(){this.timeline.renderOverview()}renderWork(){this.timeline.renderWork()}renderPlayheads(){this.timeline.renderPlayheads()}findClipByID(i){return this.timeline.findClipByID(i)}getTrimHitForBar(i,r){return this.timeline.getTrimHitForBar(i,r)}getOverviewWorkWindowHit(i){return this.timeline.getOverviewWorkWindowHit(i)}resetDrag(){this.drag={type:"none"},dt()}applyFilterStack(i){Array.isArray(i)&&this.filterPreview&&this.filterPreview.apply(i)}onClipColorChange(i){this.selectedClipId&&this.render()}onAutosaveCheck(i,r,o){i&&r&&o?this._formAutoSaveTimer||(this._formAutoSaveTimer=setTimeout(()=>{this._formAutoSaveTimer=null;let n=document.querySelector("[data-cut-autosave-trigger]");n&&n.click()},1500)):i||(clearTimeout(this._formAutoSaveTimer),this._formAutoSaveTimer=null)}}Object.assign(s.prototype,ut,ft,mt,vt,gt);function t(){let e=document.querySelector("[data-cut-page][data-video-id]");if(!e)return;let i=new s(e);if(window.cutEditor=i,window.cropRowSelect=function(o){let n=o.dataset.cropName||"",a=o.dataset.cropAspect||"",c=o.closest("[data-crop-id]")?.dataset.cropId||"",l=window.__dsAPI;l&&l.mergePatch({_selectedCropId:c,_selectedCropName:n||(a?a+" Crop":"Crop"),_selectedCropAspect:a||"custom"}),window.cutEditor&&window.cutEditor.loadCrop(c,parseFloat(o.dataset.cropX),parseFloat(o.dataset.cropY),parseFloat(o.dataset.cropW),parseFloat(o.dataset.cropH),a)},i.audioTools){let o=document.querySelector("[data-audio-meter]"),n=document.querySelector("[data-audio-spectrum]"),a=document.querySelector("[data-audio-scope]");if(o||n||a){i.audioTools.attach(o,n,a);let c=()=>{[o,n,a].forEach(h=>{if(!h)return;let u=window.devicePixelRatio||1,f=h.getBoundingClientRect();f.width>0&&f.height>0&&(h.width=Math.round(f.width*u),h.height=Math.round(f.height*u),h.getContext("2d").scale(u,u))})},l=()=>{if(i.video.removeEventListener("play",l),i.filterPreview?.audioGraph){i.filterPreview.audioGraph.ensureContext();let h=i.filterPreview.audioGraph;h.source&&h.ctx&&i.audioTools.tap(h.source,h.activeNodes.length>0?h.activeNodes[h.activeNodes.length-1]:h.source,h.ctx.destination)}c(),i.audioTools.start()};i.video.addEventListener("play",l),new ResizeObserver(c).observe(document.querySelector("[data-audio-tools]")||document.body)}if(i.video&&i.cropSurfaceEl){let c=()=>{i.updateCropSurfaceLayout(),i.renderCropOverlay()};new ResizeObserver(c).observe(i.video),window.addEventListener("resize",c)}}{let o=document.querySelector("[data-clip-bank]");o&&new MutationObserver(()=>{i.clipBank.scheduleReload()}).observe(o,{childList:!0,subtree:!0})}new MutationObserver(()=>{let o=document.body.dataset.seekTo;if(o!==void 0&&o!==""){let n=parseFloat(o);isNaN(n)||(i.videoElement.currentTime=n,delete document.body.dataset.seekTo)}}).observe(document.body,{attributes:!0,attributeFilter:["data-seek-to"]})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()})();})();
