(()=>{var _={set_in_point:"F14",set_out_point:"F15",create_clip:"F16",play_pause:"F17",seek_back:"F18",seek_forward:"F19",prev_frame:"F20",next_frame:"F21",create_marker:"F22"};function x(){let c=document.getElementById("rewind-keybindings");if(!c)return{};let t=c.dataset?.keybindings;if(!t)return{};try{return JSON.parse(t)||{}}catch(e){return console.warn("Failed to parse keybindings:",e),{}}}function P(c){let t={};return Object.entries(c||{}).forEach(([e,i])=>{i&&(t[i]=e)}),t}var g=class{constructor(t){this.container=t,this.video=t.querySelector("video"),this.videoID=t.dataset.videoId||null,this.controlsContainer=null,this.progressBar=null,this.volumeSlider=null,this.playbackRateSelect=null,this.seek={manifest:null,vttByLevel:new Map,loadingVttByLevel:new Map},this.seekTooltip=null,this.seekTooltipThumb=null,this.seekTooltipTime=null,this.progressContainer=null,this._seekTooltipRAF=null,this.isFullscreen=!1,this.isTheaterMode=!1,this.userActive=!0,this.controlsVisible=!0,this.hideControlsTimeout=null,this.settings={volume:parseFloat(localStorage.getItem("videoPlayer.volume")||"1"),playbackRate:parseFloat(localStorage.getItem("videoPlayer.playbackRate")||"1"),muted:localStorage.getItem("videoPlayer.muted")==="true"},this.positionSaveInterval=null,this.lastSavedPosition=0,this.positionSaveThreshold=2,this.qualities=[],this.qualitySelect=null,this._switchingQuality=!1,this.video&&this.init()}init(){if(!this.video){console.warn("VideoPlayer: No video element found, skipping initialization");return}this.buildControls(),this.attachEventListeners(),this.restoreSettings(),this.keyboardShortcuts=new T(this),this.initMediaSession(),this.initQualityPicker(),this.videoID&&(this.markerManager=new k(this),this.clipManager=new S(this),this.transcriptManager=new b(this),this.initSeekThumbnails(),this.initPositionTracking())}buildControls(){this.controlsContainer=this.container.querySelector(".video-controls"),this.progressContainer=this.container.querySelector(".progress-container"),this.progressBar=this.container.querySelector(".progress-bar"),this.progressFill=this.container.querySelector(".progress-fill"),this.seekTooltip=this.container.querySelector(".seek-tooltip"),this.seekTooltipThumb=this.container.querySelector(".seek-tooltip-thumb"),this.seekTooltipTime=this.container.querySelector(".seek-tooltip-time"),this.playBtn=this.container.querySelector(".play-btn"),this.timeDisplay=this.container.querySelector(".time-display"),this.volumeBtn=this.container.querySelector(".volume-btn"),this.volumeSlider=this.container.querySelector(".volume-slider"),this.playbackRateSelect=this.container.querySelector(".playback-rate-select"),this.captionBtn=this.container.querySelector(".caption-btn"),this.fullscreenBtn=this.container.querySelector(".fullscreen-btn"),this.container.classList.add("custom-video-player")}attachEventListeners(){this.playBtn.addEventListener("click",()=>this.togglePlayPause()),this.video.addEventListener("click",()=>this.togglePlayPause()),this.progressBar.addEventListener("click",t=>this.seekToPosition(t)),this.progressBar.addEventListener("mousedown",()=>{this.seeking=!0}),document.addEventListener("mouseup",()=>{this.seeking=!1}),this.progressBar.addEventListener("mousemove",t=>{this.seeking&&this.seekToPosition(t),this.queueSeekTooltipUpdate(t)}),this.progressContainer&&(this.progressContainer.addEventListener("mouseleave",()=>this.hideSeekTooltip()),this.progressContainer.addEventListener("mousemove",t=>this.queueSeekTooltipUpdate(t))),this.volumeBtn.addEventListener("click",()=>this.toggleMute()),this.volumeSlider.addEventListener("input",t=>{this.setVolume(t.target.value/100)}),this.playbackRateSelect.addEventListener("change",t=>{this.setPlaybackRate(parseFloat(t.target.value))}),this.captionBtn.addEventListener("click",()=>this.toggleCaptions()),this.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),document.addEventListener("fullscreenchange",()=>this.handleFullscreenChange()),this.video.addEventListener("play",()=>this.updatePlayButton()),this.video.addEventListener("pause",()=>this.updatePlayButton()),this.video.addEventListener("timeupdate",()=>{this.updateProgress(),this.markerManager&&this.markerManager.checkAutoSkip()}),this.video.addEventListener("loadedmetadata",()=>{this.updateProgress(),this.restoreSavedPosition()}),this.video.addEventListener("volumechange",()=>this.updateVolumeIcon()),this.video.addEventListener("pause",()=>this.saveCurrentPosition()),this.video.addEventListener("seeked",()=>this.saveCurrentPosition()),this.container.addEventListener("mousemove",()=>this.showControls()),this.container.addEventListener("mouseleave",()=>this.hideControls())}initMediaSession(){if(!(!this.video||!("mediaSession"in navigator)))try{navigator.mediaSession.setActionHandler("play",()=>this.video.play()),navigator.mediaSession.setActionHandler("pause",()=>this.video.pause()),navigator.mediaSession.setActionHandler("seekbackward",t=>{let e=t?.seekOffset||10;this.seekRelative(-e)}),navigator.mediaSession.setActionHandler("seekforward",t=>{let e=t?.seekOffset||10;this.seekRelative(e)}),navigator.mediaSession.setActionHandler("previoustrack",()=>this.seekRelative(-10)),navigator.mediaSession.setActionHandler("nexttrack",()=>this.seekRelative(10))}catch{}}initQualityPicker(){try{let i=this.container.dataset.qualities;if(!i)return;this.qualities=JSON.parse(i)}catch{return}if(this.qualities.length===0||(this.qualitySelect=this.container.querySelector(".quality-select"),!this.qualitySelect))return;let t=this.video.querySelector("source")?.getAttribute("src")||"",e=document.createElement("option");e.value=t,e.textContent="Original",e.selected=!0,this.qualitySelect.appendChild(e);for(let i of this.qualities){let s=document.createElement("option");s.value=i.src,s.textContent=i.label,this.qualitySelect.appendChild(s)}this.qualitySelect.classList.remove("hidden"),this.qualitySelect.addEventListener("change",()=>{this._switchQuality(this.qualitySelect.value)})}_switchQuality(t){if(this._switchingQuality)return;this._switchingQuality=!0;let e=!this.video.paused,i=this.video.currentTime,s=this.video.playbackRate,r=this.video.querySelector("source");r&&r.setAttribute("src",t),this.video.load();let n=()=>{this.video.removeEventListener("canplay",n),this.video.currentTime=i,this.video.playbackRate=s,e&&this.video.play().catch(()=>{}),this._switchingQuality=!1};this.video.addEventListener("canplay",n)}async initSeekThumbnails(){if(this.videoID)try{let t=await fetch(`/api/videos/${encodeURIComponent(this.videoID)}/seek/seek.json`,{headers:{Accept:"application/json"}});if(!t.ok)return;let e=await t.json();if(!e||!Array.isArray(e.levels)||e.levels.length===0)return;this.seek.manifest=e}catch{}}queueSeekTooltipUpdate(t){!this.seekTooltip||!this.seekTooltipThumb||!this.seekTooltipTime||this.seek.manifest&&(!this.video||!isFinite(this.video.duration)||this.video.duration<=0||this.progressBar&&(this._seekTooltipRAF||(this._seekTooltipRAF=requestAnimationFrame(()=>{this._seekTooltipRAF=null,this.updateSeekTooltip(t)}))))}hideSeekTooltip(){this.seekTooltip&&this.seekTooltip.classList.add("hidden")}chooseSeekLevel(){let t=this.seek?.manifest?.levels;if(!Array.isArray(t)||t.length===0)return null;let e=t.find(s=>(s?.name||"")==="medium");if(!this.seeking&&e)return e;let i=null;for(let s of t){let r=Number(s?.interval_seconds);!isFinite(r)||r<=0||(!i||r<Number(i.interval_seconds))&&(i=s)}return i||e||t[0]}async ensureSeekVttLoaded(t){if(!t||typeof t!="string")return null;if(this.seek.vttByLevel.has(t))return this.seek.vttByLevel.get(t);if(this.seek.loadingVttByLevel.has(t))return this.seek.loadingVttByLevel.get(t);let e=(async()=>{try{let i=await fetch(`/api/videos/${encodeURIComponent(this.videoID)}/seek/levels/${encodeURIComponent(t)}/seek.vtt`,{headers:{Accept:"text/vtt"}});if(!i.ok)return null;let s=await i.text(),r=this.parseSeekVTT(s);return r&&this.seek.vttByLevel.set(t,r),r}catch{return null}finally{this.seek.loadingVttByLevel.delete(t)}})();return this.seek.loadingVttByLevel.set(t,e),e}parseSeekVTT(t){if(typeof t!="string")return null;let e=t.replace(/\r/g,"").split(`
`),i=[],s=0,r=n=>{let l=n.match(/^(\d+):(\d\d):(\d\d)\.(\d\d\d)$/);if(!l)return null;let u=Number(l[1]),o=Number(l[2]),h=Number(l[3]),a=Number(l[4]);return[u,o,h,a].every(d=>isFinite(d))?u*3600+o*60+h+a/1e3:null};for(;s<e.length;){let n=e[s].trim();if(s++,!n||n.startsWith("WEBVTT")||n.startsWith("NOTE")||!n.includes("-->"))continue;let l=n.split("-->").map(d=>d.trim()),u=r(l[0]),o=r(l[1]);if(u==null||o==null)continue;for(;s<e.length&&!e[s].trim();)s++;if(s>=e.length)break;let h=e[s].trim();s++;let a=h.match(/^(seek-\d{3}\.jpg)#xywh=(\d+),(\d+),(\d+),(\d+)$/);a&&i.push({start:u,end:o,sheet:a[1],x:Number(a[2]),y:Number(a[3]),w:Number(a[4]),h:Number(a[5])})}return i.length>0?i:null}async updateSeekTooltip(t){if(!this.seekTooltip||!this.seekTooltipThumb||!this.seekTooltipTime||!this.seek.manifest||!this.progressBar||!this.video||!isFinite(this.video.duration)||this.video.duration<=0)return;let e=this.progressBar.getBoundingClientRect(),i=Math.max(0,Math.min(e.width,t.clientX-e.left)),r=(e.width>0?i/e.width:0)*this.video.duration,n=this.chooseSeekLevel(),l=(n?.name||"").toString();if(!l){this.hideSeekTooltip();return}let u=await this.ensureSeekVttLoaded(l);if(!u||u.length===0){this.hideSeekTooltip();return}let o=Number(n?.interval_seconds),h=isFinite(o)&&o>0?Math.floor(r/o):-1;(!isFinite(h)||h<0)&&(h=0),h>=u.length&&(h=u.length-1);let a=u[h];if(!a){this.hideSeekTooltip();return}let d=`/api/videos/${encodeURIComponent(this.videoID)}/seek/levels/${encodeURIComponent(l)}/${encodeURIComponent(a.sheet)}`,p=Number(n?.cols)*Number(n?.thumb_width),f=Number(n?.rows)*Number(n?.thumb_height);this.seekTooltipThumb.style.width=`${a.w}px`,this.seekTooltipThumb.style.height=`${a.h}px`,this.seekTooltipThumb.style.backgroundImage=`url(${d})`,this.seekTooltipThumb.style.backgroundRepeat="no-repeat",isFinite(p)&&isFinite(f)&&p>0&&f>0?this.seekTooltipThumb.style.backgroundSize=`${p}px ${f}px`:this.seekTooltipThumb.style.backgroundSize="",this.seekTooltipThumb.style.backgroundPosition=`-${a.x}px -${a.y}px`,this.seekTooltipTime.textContent=this.formatTime(r);let m=this.seekTooltip;m.classList.remove("hidden");let y=m.offsetWidth||0,v=i;y>0&&(v=Math.max(y/2,Math.min(e.width-y/2,v))),m.style.left=`${v}px`}restoreSettings(){this.video.volume=this.settings.volume,this.video.muted=this.settings.muted,this.video.playbackRate=this.settings.playbackRate,this.volumeSlider.value=this.settings.volume*100,this.playbackRateSelect.value=this.settings.playbackRate,this.updateVolumeIcon(),this.restoreCaptionSettings()}toggleCaptions(){let t=Array.from(this.video.textTracks);if(t.length===0)return;let e=t.find(i=>i.kind==="subtitles"||i.kind==="captions");e&&(e.mode==="showing"?(e.mode="hidden",this.captionBtn.classList.add("text-white/60"),this.captionBtn.classList.remove("text-white"),localStorage.setItem("videoPlayer.captionsEnabled","false")):(e.mode="showing",this.captionBtn.classList.remove("text-white/60"),this.captionBtn.classList.add("text-white"),localStorage.setItem("videoPlayer.captionsEnabled","true")))}restoreCaptionSettings(){let t=localStorage.getItem("videoPlayer.captionsEnabled"),e=Array.from(this.video.textTracks);if(e.length===0)return;let i=e.find(s=>s.kind==="subtitles"||s.kind==="captions");i&&(t==="true"?(i.mode="showing",this.captionBtn.classList.remove("text-white/60"),this.captionBtn.classList.add("text-white")):t==="false"?(i.mode="hidden",this.captionBtn.classList.add("text-white/60")):i.mode!=="showing"?this.captionBtn.classList.add("text-white/60"):this.captionBtn.classList.add("text-white"))}togglePlayPause(){this.video.paused?this.video.play():this.video.pause()}updatePlayButton(){let t=this.playBtn.querySelector(".play-icon"),e=this.playBtn.querySelector(".pause-icon");this.video.paused?(t.classList.remove("hidden"),e.classList.add("hidden")):(t.classList.add("hidden"),e.classList.remove("hidden"))}seekToPosition(t){let e=this.progressBar.getBoundingClientRect(),i=(t.clientX-e.left)/e.width;this.video.currentTime=i*this.video.duration}updateProgress(){if(!this.video.duration)return;let t=this.video.currentTime/this.video.duration*100;this.progressFill.style.width=t+"%";let e=this.formatTime(this.video.currentTime),i=this.formatTime(this.video.duration);this.timeDisplay.textContent=`${e} / ${i}`,this.markerManager&&this.markerManager.renderIfNeeded(),this.clipManager&&this.clipManager.renderIfNeeded()}formatTime(t){if(isNaN(t))return"0:00";let e=Math.floor(t/3600),i=Math.floor(t%3600/60),s=Math.floor(t%60);return e>0?`${e}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${i}:${s.toString().padStart(2,"0")}`}toggleMute(){this.video.muted=!this.video.muted,this.settings.muted=this.video.muted,localStorage.setItem("videoPlayer.muted",this.video.muted),this.updateVolumeIcon()}setVolume(t){this.video.volume=t,this.settings.volume=t,localStorage.setItem("videoPlayer.volume",t),t>0&&this.video.muted&&(this.video.muted=!1,this.settings.muted=!1,localStorage.setItem("videoPlayer.muted","false")),this.updateVolumeIcon()}updateVolumeIcon(){let t=this.volumeBtn.querySelector(".volume-high-icon"),e=this.volumeBtn.querySelector(".volume-muted-icon");this.video.muted||this.video.volume===0?(t.classList.add("hidden"),e.classList.remove("hidden")):(t.classList.remove("hidden"),e.classList.add("hidden"))}setPlaybackRate(t){this.video.playbackRate=t,this.settings.playbackRate=t,localStorage.setItem("videoPlayer.playbackRate",t)}toggleFullscreen(){this.isFullscreen?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():this.container.requestFullscreen?this.container.requestFullscreen():this.container.webkitRequestFullscreen&&this.container.webkitRequestFullscreen()}handleFullscreenChange(){this.isFullscreen=!!document.fullscreenElement;let t=this.fullscreenBtn.querySelector(".fullscreen-enter-icon"),e=this.fullscreenBtn.querySelector(".fullscreen-exit-icon");this.isFullscreen?(t.classList.add("hidden"),e.classList.remove("hidden"),this.container.classList.add("fullscreen")):(t.classList.remove("hidden"),e.classList.add("hidden"),this.container.classList.remove("fullscreen"))}toggleTheaterMode(){this.isTheaterMode=!this.isTheaterMode,this.container.classList.toggle("theater-mode",this.isTheaterMode),this.container.dispatchEvent(new CustomEvent("theatermodechange",{detail:{enabled:this.isTheaterMode}}))}togglePictureInPicture(){document.pictureInPictureElement?document.exitPictureInPicture():document.pictureInPictureEnabled&&this.video.requestPictureInPicture()}showControls(){this.controlsVisible=!0,this.controlsContainer.classList.remove("hidden"),clearTimeout(this.hideControlsTimeout),this.video.paused||(this.hideControlsTimeout=setTimeout(()=>{this.hideControls()},3e3))}hideControls(){this.video.paused||(this.controlsVisible=!1,this.controlsContainer.classList.add("hidden"))}seekRelative(t){this.video.currentTime=Math.max(0,Math.min(this.video.duration,this.video.currentTime+t))}changeVolume(t){let e=Math.max(0,Math.min(1,this.video.volume+t));this.setVolume(e),this.volumeSlider.value=e*100}changePlaybackRate(t){let e=[.25,.5,.75,1,1.25,1.5,1.75,2],i=e.indexOf(this.video.playbackRate),s=Math.max(0,Math.min(e.length-1,i+Math.sign(t)));this.setPlaybackRate(e[s]),this.playbackRateSelect.value=e[s]}seekToPercent(t){this.video.currentTime=t/100*this.video.duration}initPositionTracking(){this.positionSaveInterval=setInterval(()=>{!this.video.paused&&!this.video.ended&&this.saveCurrentPosition()},5e3),window.addEventListener("beforeunload",()=>{this.saveCurrentPosition()})}restoreSavedPosition(){let t=parseFloat(this.container.dataset.savedPosition||"0");t>1&&t<this.video.duration-5&&(this.video.currentTime=t,console.log(`Restored playback position: ${t.toFixed(2)}s`))}saveCurrentPosition(){if(!this.videoID||!this.video)return;let t=this.video.currentTime;Math.abs(t-this.lastSavedPosition)<this.positionSaveThreshold||(this.lastSavedPosition=t,fetch(`/api/videos/${encodeURIComponent(this.videoID)}/position`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({position:t})}).catch(e=>{console.debug("Failed to save playback position:",e)}))}},k=class{constructor(t){this.player=t,this.markers=[],this.skipSegments=[],this.lastSkipCheck=0,this.renderedForDuration=null,this.loading=!1,this._initialLoadDone=!1,this.panel=this.findPanel(),this.listEl=this.panel?.querySelector("[data-markers-list]")||null,this.load()}findPanel(){return this.player.videoID?document.querySelector(`[data-video-panel][data-video-id="${CSS.escape(this.player.videoID)}"]`):null}async load(){if(this.player.videoID){this.loading=!0;try{let t=await fetch(`/api/videos/${encodeURIComponent(this.player.videoID)}/markers`,{headers:{Accept:"application/json"}});if(!t.ok)return;this.markers=await t.json(),this.skipSegments=this.markers.filter(e=>e.duration&&e.duration>0),this.renderedForDuration=null,this.renderIfNeeded(),this._initialLoadDone?this.renderList():this._initialLoadDone=!0}catch{}finally{this.loading=!1}}}formatTime(t){if(!isFinite(t)||t<0)return"0:00";let e=Math.floor(t/3600),i=Math.floor(t%3600/60),s=Math.floor(t%60);return e>0?`${e}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${i}:${s.toString().padStart(2,"0")}`}renderList(){this._triggerRefresh()}_triggerRefresh(){let t=document.querySelector("[data-markers-refresh]");t&&t.click()}async deleteMarker(t){if(!(!t||typeof t!="string")&&!t.startsWith("sb:"))try{if(!(await fetch(`/api/markers/${encodeURIComponent(t)}`,{method:"DELETE"})).ok)return;await this.load()}catch{}}checkAutoSkip(){let t=this.player.video.currentTime;if(!(Math.abs(t-this.lastSkipCheck)<.5)){this.lastSkipCheck=t;for(let e of this.skipSegments){let i=e.timestamp,s=i+e.duration;if(t>=i&&t<s){localStorage.getItem("videoPlayer.autoSkipSponsors")!=="false"?this.skipSegment(e,s):this.showSkipButton(e,s);break}}}}skipSegment(t,e){console.log(`[SponsorBlock] Auto-skipping: ${t.title}`),this.player.video.currentTime=e+.1,this.showSkipNotification(t)}showSkipNotification(t){let e=this.player.container.querySelector("[data-skip-notification]");if(!e)return;let i=e.querySelector("[data-skip-notification-text]");i&&(i.textContent=`Skipped: ${t.title}`),e.classList.remove("hidden","fade-out"),clearTimeout(this._skipNotifTimeout),this._skipNotifTimeout=setTimeout(()=>{e.classList.add("fade-out"),setTimeout(()=>e.classList.add("hidden"),300)},2e3)}showSkipButton(t,e){console.log(`[SponsorBlock] Segment available to skip: ${t.title}`)}renderIfNeeded(){let t=this.player.video.duration;!t||!isFinite(t)||t<=0||this.renderedForDuration!==t&&(this.renderedForDuration=t,this.render())}clearTicks(){this.player.progressBar.querySelectorAll(".marker-tick, .marker-range").forEach(t=>t.remove())}render(){if(!this.player.progressBar)return;this.clearTicks();let t=this.player.video.duration;!t||!isFinite(t)||t<=0||(this.markers||[]).forEach(e=>{let i=typeof e.timestamp=="number"?e.timestamp:NaN;if(!(!isFinite(i)||i<0||i>t))if(e.duration&&e.duration>0){let s=i,r=Math.min(i+e.duration,t),n=document.createElement("div");n.className="marker-range",n.style.left=`${s/t*100}%`,n.style.width=`${(r-s)/t*100}%`,e.color&&(n.style.background=e.color),e.title&&(n.title=`${e.title} (${e.duration.toFixed(1)}s)`),n.addEventListener("click",l=>{l.stopPropagation(),this.player.video.currentTime=s}),this.player.progressBar.appendChild(n)}else{let s=document.createElement("div");s.className="marker-tick",s.style.left=`${i/t*100}%`,e.color&&(s.style.background=e.color),e.title&&(s.title=e.title),s.addEventListener("click",r=>{r.stopPropagation(),this.player.video.currentTime=i}),this.player.progressBar.appendChild(s)}})}async createMarkerAtCurrentTime(){if(!this.player.videoID)return;let t=this.player.video.currentTime;if(!(!isFinite(t)||t<0))try{if(!(await fetch(`/api/videos/${encodeURIComponent(this.player.videoID)}/markers`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({timestamp:t,title:"",description:"",color:"",marker_type:"point"})})).ok)return;await this.load()}catch{}}},b=class{constructor(t){this.player=t,this.panel=this.findPanel(),this.listEl=this.panel?.querySelector("[data-transcript-list]")||null,this.searchEl=this.panel?.querySelector("[data-transcript-search]")||null,this.cueElements=[],this.activeCueIndex=-1,this.userScrolling=!1,this.scrollTimeout=null,this.panel&&this.listEl&&(this.attach(),new MutationObserver(()=>this._discoverCues()).observe(this.listEl,{childList:!0,subtree:!0}))}findPanel(){return this.player.videoID?document.querySelector(`[data-transcript-panel][data-video-id="${CSS.escape(this.player.videoID)}"]`):null}attach(){this.searchEl&&this.searchEl.addEventListener("input",()=>this.applyFilter()),this.player.video&&this.player.video.addEventListener("timeupdate",()=>this.onTimeUpdate()),this.listEl&&this.listEl.addEventListener("scroll",()=>{this.userScrolling=!0,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.userScrolling=!1},3e3)},{passive:!0})}_discoverCues(){this.listEl&&(this.cueElements=Array.from(this.listEl.querySelectorAll("[data-cue-start]")),this.activeCueIndex=-1,this.searchEl?.value?.trim()&&this.applyFilter(),this.onTimeUpdate())}onTimeUpdate(){if(!this.player.video||!this.cueElements.length)return;let t=this.player.video.currentTime,e=-1,i=this.cueElements.filter(n=>!n.classList.contains("hidden"));for(let n=0;n<i.length&&parseFloat(i[n].dataset.cueStart)<=t;n++)e=n;let s=e>=0?i[e]:null,r=s?this.cueElements.indexOf(s):-1;r!==this.activeCueIndex&&this.setActiveCue(r)}setActiveCue(t){if(this.activeCueIndex>=0&&this.cueElements[this.activeCueIndex]&&this.cueElements[this.activeCueIndex].classList.remove("bg-white/10","border-l-2","border-white/40","pl-2"),this.activeCueIndex=t,t>=0&&this.cueElements[t]){let e=this.cueElements[t];if(e.classList.add("bg-white/10","border-l-2","border-white/40","pl-2"),!this.userScrolling&&this.listEl){let i=this.listEl.clientHeight,s=e.offsetTop-this.listEl.offsetTop,r=e.offsetHeight,n=s-i/2+r/2;this.listEl.scrollTo({top:n,behavior:"smooth"})}}}applyFilter(){let t=(this.searchEl?.value||"").trim().toLowerCase();this.activeCueIndex=-1,this.cueElements.forEach(e=>{let i=(e.dataset.cueText||"").toLowerCase();e.classList.toggle("hidden",t!==""&&!i.includes(t))}),this.onTimeUpdate()}},S=class{constructor(t){this.player=t,this.clips=[],this.inPoint=null,this.outPoint=null,this.renderedForDuration=null,this.panel=this.findPanel(),this.listEl=this.panel?.querySelector("[data-clips-list]")||null,this.rangeEl=this.panel?.querySelector("[data-clip-range]")||null,this.btnSetIn=this.panel?.querySelector("[data-clip-set-in]")||null,this.btnSetOut=this.panel?.querySelector("[data-clip-set-out]")||null,this.btnCreate=this.panel?.querySelector("[data-clip-create]")||null,this.attachPanelListeners(),this.timeline={addClip:e=>this.timelineAddClip(e),removeClip:e=>this.timelineRemoveClip(e),updateClip:(e,i)=>this.timelineUpdateClip(e,i),clear:()=>this.timelineClear()},this.loadClipsForTimeline()}findPanel(){return this.player.videoID?document.querySelector(`[data-video-panel][data-video-id="${CSS.escape(this.player.videoID)}"]`):null}attachPanelListeners(){this.btnSetIn&&this.btnSetIn.addEventListener("click",()=>this.setInPoint()),this.btnSetOut&&this.btnSetOut.addEventListener("click",()=>this.setOutPoint()),this.btnCreate&&this.btnCreate.addEventListener("click",()=>this.createClipFromRange()),this.renderRange()}renderRange(){if(!this.rangeEl)return;let t=e=>typeof e=="number"&&isFinite(e)?e.toFixed(2):"--";this.rangeEl.textContent=`In: ${t(this.inPoint)}  Out: ${t(this.outPoint)}`}setInPoint(){let t=this.player.video.currentTime;!isFinite(t)||t<0||(this.inPoint=t,this.renderRange())}setOutPoint(){let t=this.player.video.currentTime;!isFinite(t)||t<0||(this.outPoint=t,this.renderRange())}async loadClipsForTimeline(){if(this.player.videoID)try{let t=await fetch(`/api/videos/${encodeURIComponent(this.player.videoID)}/clips`,{headers:{Accept:"application/json"}});if(!t.ok)return;this.clips=await t.json(),this.renderTimeline()}catch{}}timelineAddClip(t){let e=this.clips.find(i=>i.ID===t.id||i.id===t.id);e?Object.assign(e,{ID:t.id,StartTs:t.startTime,EndTs:t.endTime,Color:t.color,Title:t.title}):this.clips.push({ID:t.id,StartTs:t.startTime,EndTs:t.endTime,Color:t.color,Title:t.title}),this.renderTimeline()}timelineRemoveClip(t){this.clips=this.clips.filter(e=>e.ID!==t&&e.id!==t),this.renderTimeline()}timelineUpdateClip(t,e){let i=this.clips.find(s=>s.ID===t||s.id===t);i&&(e.startTime!==void 0&&(i.StartTs=e.startTime),e.endTime!==void 0&&(i.EndTs=e.endTime),e.color!==void 0&&(i.Color=e.color),e.title!==void 0&&(i.Title=e.title),this.renderTimeline())}timelineClear(){this.clips=[],this.clearTimeline()}clearTimeline(){this.player.progressBar?.querySelectorAll(".clip-range").forEach(t=>t.remove())}renderIfNeeded(){let t=this.player.video.duration;!t||!isFinite(t)||t<=0||this.renderedForDuration!==t&&(this.renderedForDuration=t,this.renderTimeline())}renderTimeline(){if(!this.player.progressBar)return;let t=this.player.video.duration;!t||!isFinite(t)||t<=0||(this.clearTimeline(),(this.clips||[]).forEach(e=>{let i=e.StartTs??e.start_ts??0,s=e.EndTs??e.end_ts??0;if(!isFinite(i)||!isFinite(s)||s<=i||i<0||i>t)return;let r=Math.max(0,Math.min(i,t)),n=Math.max(0,Math.min(s,t));if(n<=r)return;let l=r/t*100,u=(n-r)/t*100,o=document.createElement("div");o.className="clip-range",o.style.left=`${l}%`,o.style.width=`${u}%`;let h=(e.color||e.Color||"").toString().trim();h&&(o.style.background=h);let a=(e.title||e.Title||"").toString().trim();a&&(o.title=a),o.addEventListener("click",d=>{d.stopPropagation();let p=this.player.progressBar.getBoundingClientRect(),f=p.width>0?(d.clientX-p.left)/p.width:0;this.player.video.currentTime=Math.max(0,Math.min(f,1))*t}),this.player.progressBar.appendChild(o)}))}async createClipFromRange(){if(!this.player.videoID||typeof this.inPoint!="number"||typeof this.outPoint!="number")return;let t=Math.min(this.inPoint,this.outPoint),e=Math.max(this.inPoint,this.outPoint);if(!isFinite(t)||!isFinite(e)||e<=t)return;let i=this.panel?.querySelector("[data-clip-create-start]"),s=this.panel?.querySelector("[data-clip-create-end]"),r=this.panel?.querySelector("[data-clip-create-submit]");!i||!s||!r||(i.value=t,s.value=e,i.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("input",{bubbles:!0})),r.click())}async deleteClip(t){if(!(!t||typeof t!="string"))try{let e=await fetch(`/api/clips/${encodeURIComponent(t)}`,{method:"DELETE"})}catch{}}},T=class{constructor(t){this.player=t,this.enabled=!0,this.keybindings={..._,...x()},this.keyMap=P(this.keybindings),this.attachListeners()}attachListeners(){document.addEventListener("keydown",t=>{this.enabled&&(t.target?.isContentEditable||t.target?.tagName==="INPUT"||t.target?.tagName==="TEXTAREA"||t.target?.tagName==="SELECT"||this.handleKeyPress(t))})}handleKeyPress(t){let e=t.key,i=e.toLowerCase(),s=t.ctrlKey||t.metaKey||t.altKey;if(e==="MediaPlayPause"){t.preventDefault(),this.player.togglePlayPause();return}if(e==="MediaTrackPrevious"){t.preventDefault(),this.player.seekRelative(-10);return}if(e==="MediaTrackNext"){t.preventDefault(),this.player.seekRelative(10);return}if(!s){let r=this.keyMap[e];if(r){t.preventDefault(),this.executeKeybindingAction(r);return}}if((i==="k"||i===" ")&&!s){t.preventDefault(),this.player.togglePlayPause();return}if(i==="arrowleft"&&!t.shiftKey&&!s){t.preventDefault(),this.player.seekRelative(-5);return}if(i==="arrowright"&&!t.shiftKey&&!s){t.preventDefault(),this.player.seekRelative(5);return}if(i===","&&this.player.video.paused&&!s){t.preventDefault(),this.previousFrame();return}if(i==="."&&this.player.video.paused&&!s){t.preventDefault(),this.nextFrame();return}if(i==="<"||i===","&&t.shiftKey){t.preventDefault(),this.player.changePlaybackRate(-1);return}if(i===">"||i==="."&&t.shiftKey){t.preventDefault(),this.player.changePlaybackRate(1);return}if(/^[0-9]$/.test(i)&&!s){t.preventDefault(),this.player.seekToPercent(parseInt(i)*10);return}if(i==="f"&&!s){t.preventDefault(),this.player.toggleFullscreen();return}if(i==="t"&&!s){t.preventDefault(),this.player.toggleTheaterMode();return}if(i==="i"&&!t.shiftKey&&!s){t.preventDefault(),this.player.togglePictureInPicture();return}if(i==="escape"){this.player.isFullscreen&&this.player.toggleFullscreen();return}if(i==="i"&&t.shiftKey&&!s){t.preventDefault(),this.player.clipManager?.setInPoint();return}if(i==="o"&&t.shiftKey&&!s){t.preventDefault(),this.player.clipManager?.setOutPoint();return}if(i==="c"&&t.shiftKey&&!s){t.preventDefault(),this.player.clipManager?.createClipFromRange();return}if(i==="m"&&t.shiftKey&&!s){t.preventDefault(),this.player.markerManager?.createMarkerAtCurrentTime();return}if(i==="m"&&!s){t.preventDefault(),this.player.toggleMute();return}if(i==="c"&&!s){t.preventDefault(),this.player.toggleCaptions();return}if(i==="arrowup"&&!s){t.preventDefault(),this.player.changeVolume(.05);return}i==="arrowdown"&&!s&&(t.preventDefault(),this.player.changeVolume(-.05))}executeKeybindingAction(t){switch(t){case"set_in_point":this.player.clipManager?.setInPoint();break;case"set_out_point":this.player.clipManager?.setOutPoint();break;case"create_clip":this.player.clipManager?.createClipFromRange();break;case"play_pause":this.player.togglePlayPause();break;case"seek_back":this.player.seekRelative(-10);break;case"seek_forward":this.player.seekRelative(10);break;case"prev_frame":this.previousFrame();break;case"next_frame":this.nextFrame();break;case"create_marker":this.player.markerManager?.createMarkerAtCurrentTime();break;default:break}}previousFrame(){if(!this.player.video.paused)return;let e=1/30;this.player.video.currentTime=Math.max(0,this.player.video.currentTime-e)}nextFrame(){if(!this.player.video.paused)return;let e=1/30;this.player.video.currentTime=Math.min(this.player.video.duration,this.player.video.currentTime+e)}};window.seekToTime=function(c){let t=document.getElementById("videoPlayer");t&&isFinite(c)&&c>=0&&(t.currentTime=c)};document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-video-player]").forEach(t=>{new g(t)})});})();
